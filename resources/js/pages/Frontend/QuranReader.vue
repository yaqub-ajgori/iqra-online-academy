<template>
    <FrontendLayout title="ржХрзБрж░ржЖржи ржкрж╛ржа - ржЗржХрж░рж╛ ржЕржирж▓рж╛ржЗржи ржПржХрж╛ржбрзЗржорж┐">
        <Head title="ржХрзБрж░ржЖржи ржкрж╛ржа - ржЗржХрж░рж╛ ржЕржирж▓рж╛ржЗржи ржПржХрж╛ржбрзЗржорж┐" />

        <div class="mx-auto max-w-7xl px-3 py-3 sm:px-6 sm:py-8 lg:px-8">
            <!-- Mobile-First Compact Header -->
            <div class="py-2 text-center sm:py-4">
                <h1
                    class="mb-2 bg-gradient-to-r from-[#2d5a27] via-[#5f5fcd] to-[#2d5a27] bg-clip-text text-2xl font-bold text-transparent sm:mb-3 sm:text-4xl md:text-5xl"
                >
                    ржкржмрж┐рждрзНрж░ ржХрзБрж░ржЖржи рж╢рж░рзАржл
                </h1>
                <p class="mx-auto mb-2 max-w-xl px-4 text-sm leading-relaxed text-gray-600 sm:px-0 sm:text-lg">
                    рж╕рзБржирзНржжрж░ ржЯрж╛ржЗржкрзЛржЧрзНрж░рж╛ржлрж┐, ржоржирзЛрж░ржо ржХржгрзНржарж╕рзНржмрж░ ржПржмржВ рж╕рж╣ржЬ ржирзЗржнрж┐ржЧрзЗрж╢ржи рж╕рж╣ ржХрзБрж░ржЖржи ржкржбрж╝рзБржи ржУ рж╢рзБржирзБржиред
                </p>
                <div class="flex items-center justify-center">
                    <span
                        class="rounded-full border border-[#5f5fcd]/20 bg-gradient-to-r from-[#5f5fcd]/10 to-[#2d5a27]/10 px-3 py-1 text-xs font-semibold text-[#5f5fcd] sm:text-sm"
                    >
                        ржЗржХрж░рж╛ ржЕржирж▓рж╛ржЗржи ржПржХрж╛ржбрзЗржорж┐
                    </span>
                </div>
            </div>

            <!-- Premium Search Bar -->
            <div
                class="mb-4 rounded-xl border border-[#5f5fcd]/10 bg-gradient-to-r from-[#5f5fcd]/5 via-white to-[#2d5a27]/5 p-3 shadow-lg sm:mb-6 sm:rounded-2xl sm:p-4"
            >
                <div class="flex flex-col gap-3 sm:flex-row sm:gap-4">
                    <!-- Search Input -->
                    <div class="relative flex-1">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-[#5f5fcd]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                />
                            </svg>
                        </div>
                        <input
                            v-model="searchQuery"
                            @keyup.enter="performSearch"
                            type="text"
                            placeholder="ржХрзБрж░ржЖржирзЗ ржЦрзБржБржЬрзБржи... (ржЖрж░ржмрж┐ ржЕржержмрж╛ ржмрж╛ржВрж▓рж╛)"
                            class="w-full rounded-lg border-2 border-[#5f5fcd]/20 bg-white py-3 pr-4 pl-10 font-medium text-gray-700 placeholder-gray-500 transition-all duration-300 focus:border-[#5f5fcd] focus:ring-2 focus:ring-[#5f5fcd]/30"
                        />
                        <div v-if="searchLoading" class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <div class="h-5 w-5 animate-spin rounded-full border-b-2 border-[#5f5fcd]"></div>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button
                        @click="performSearch"
                        :disabled="searchLoading || !searchQuery.trim()"
                        class="flex min-w-[100px] items-center justify-center rounded-lg bg-gradient-to-r from-[#5f5fcd] to-[#2d5a27] px-4 py-3 font-semibold text-white transition-all duration-300 hover:shadow-md disabled:cursor-not-allowed disabled:opacity-50 sm:px-6"
                    >
                        <svg v-if="!searchLoading" class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <div v-if="searchLoading" class="mr-2 h-5 w-5 animate-spin rounded-full border-b-2 border-white"></div>
                        <span>{{ searchLoading ? 'ржЦрзБржБржЬржЫрж┐...' : 'ржЦрзБржБржЬрзБржи' }}</span>
                    </button>
                </div>

                <!-- Advanced Search Filters -->
                <div v-if="searchQuery.trim()" class="mt-3 space-y-3 sm:mt-4">
                    <!-- Primary Filters -->
                    <div class="flex flex-wrap gap-2 sm:gap-3">
                        <button
                            @click="searchIn = 'all'"
                            :class="[
                                'rounded-full px-3 py-1.5 text-sm font-medium transition-all duration-200',
                                searchIn === 'all' ? 'bg-[#5f5fcd] text-white' : 'bg-[#5f5fcd]/10 text-[#5f5fcd] hover:bg-[#5f5fcd]/20',
                            ]"
                        >
                            рж╕ржм рж╕рзВрж░рж╛
                        </button>
                        <button
                            @click="searchIn = 'current'"
                            :class="[
                                'rounded-full px-3 py-1.5 text-sm font-medium transition-all duration-200',
                                searchIn === 'current' ? 'bg-[#2d5a27] text-white' : 'bg-[#2d5a27]/10 text-[#2d5a27] hover:bg-[#2d5a27]/20',
                            ]"
                        >
                            ржмрж░рзНрждржорж╛ржи {{ currentSurah ? 'рж╕рзВрж░рж╛' : currentJuz ? 'ржкрж╛рж░рж╛' : selectedPage ? 'ржкрзГрж╖рзНржарж╛' : 'ржирж┐рж░рзНржмрж╛ржЪржи' }}
                        </button>
                        <button
                            @click="searchLanguage = searchLanguage === 'arabic' ? 'bengali' : 'arabic'"
                            :class="[
                                'rounded-full px-3 py-1.5 text-sm font-medium transition-all duration-200',
                                'bg-[#d4a574]/10 text-[#d4a574] hover:bg-[#d4a574]/20',
                            ]"
                        >
                            {{ searchLanguage === 'arabic' ? 'ржЖрж░ржмрж┐' : 'ржмрж╛ржВрж▓рж╛' }}
                        </button>
                        <button
                            v-if="searchResults.length > 0"
                            @click="clearSearch"
                            class="rounded-full bg-red-100 px-3 py-1.5 text-sm font-medium text-red-600 transition-all duration-200 hover:bg-red-200"
                        >
                            тЬХ рж╕рж╛ржл ржХрж░рзБржи
                        </button>
                    </div>

                    <!-- Concept-Based Search Suggestions -->
                    <div v-if="conceptSuggestions.length > 0" class="border-t border-gray-200 pt-3">
                        <p class="mb-2 text-xs text-gray-600">ЁЯТб рж╕ржВрж╢рзНрж▓рж┐рж╖рзНржЯ ржмрж┐рж╖ржпрж╝:</p>
                        <div class="flex flex-wrap gap-2">
                            <button
                                v-for="concept in conceptSuggestions.slice(0, 6)"
                                :key="concept.id"
                                @click="searchByConcept(concept)"
                                class="rounded-full border border-[#5f5fcd]/20 bg-gradient-to-r from-[#5f5fcd]/5 to-[#2d5a27]/5 px-3 py-1.5 text-xs font-medium text-[#2d5a27] transition-all duration-200 hover:from-[#5f5fcd]/10 hover:to-[#2d5a27]/10"
                            >
                                {{ concept.icon }} {{ concept.name }}
                            </button>
                        </div>
                    </div>

                    <!-- Search History -->
                    <div v-if="searchHistory.length > 0" class="border-t border-gray-200 pt-3">
                        <p class="mb-2 text-xs text-gray-600">ЁЯХР рж╕рж╛ржорзНржкрзНрж░рждрж┐ржХ ржЕржирзБрж╕ржирзНржзрж╛ржи:</p>
                        <div class="flex flex-wrap gap-2">
                            <button
                                v-for="term in searchHistory.slice(0, 5)"
                                :key="term"
                                @click="
                                    searchQuery = term;
                                    performSearch();
                                "
                                class="rounded-full bg-gray-100 px-3 py-1.5 text-xs text-gray-700 transition-all duration-200 hover:bg-gray-200"
                            >
                                {{ term }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic-Based Study Section -->
            <div
                class="mb-4 rounded-xl border border-[#d4a574]/10 bg-gradient-to-r from-[#d4a574]/5 via-white to-[#5f5fcd]/5 p-3 shadow-lg sm:mb-6 sm:rounded-2xl sm:p-4"
            >
                <div class="mb-3 flex items-center justify-between sm:mb-4">
                    <h3 class="flex items-center text-lg font-bold text-[#2d5a27] sm:text-xl">
                        <svg class="mr-2 h-5 w-5 sm:h-6 sm:w-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ржмрж┐рж╖ржпрж╝ржнрж┐рждрзНрждрж┐ржХ ржЕржзрзНржпржпрж╝ржи
                    </h3>
                    <button
                        @click="showTopics = !showTopics"
                        class="flex items-center rounded-lg bg-[#d4a574]/15 px-3 py-1.5 font-semibold text-[#8B5A3C] transition-all duration-200 hover:bg-[#d4a574]/25 hover:text-[#6B4423]"
                    >
                        <span class="mr-1 text-sm font-medium">{{ showTopics ? 'рж▓рзБржХрж╛ржи' : 'ржжрзЗржЦрзБржи' }}</span>
                        <svg
                            class="h-4 w-4 transition-transform duration-200"
                            :class="{ 'rotate-180': showTopics }"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>

                <div v-if="showTopics" class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3">
                    <div
                        v-for="topic in topicCategories"
                        :key="topic.id"
                        @click="selectTopic(topic)"
                        class="group relative cursor-pointer rounded-xl border p-3 transition-all duration-300 hover:scale-105 hover:transform sm:p-4"
                        :class="{
                            'pointer-events-none opacity-50': topicLoading && selectedTopic?.id === topic.id,
                            'border-[#d4a574] bg-gradient-to-br from-[#d4a574]/20 to-[#5f5fcd]/20 shadow-lg': selectedTopic?.id === topic.id,
                            'border-[#d4a574]/20 bg-gradient-to-br from-white to-[#f8f9ff] hover:border-[#d4a574]/40 hover:shadow-md':
                                selectedTopic?.id !== topic.id,
                        }"
                    >
                        <div class="mb-2 flex items-center">
                            <div
                                class="mr-3 flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-[#d4a574] to-[#5f5fcd] sm:h-10 sm:w-10"
                            >
                                <div
                                    v-if="topicLoading && selectedTopic?.id === topic.id"
                                    class="h-4 w-4 animate-spin rounded-full border-b-2 border-white"
                                ></div>
                                <span v-else class="text-lg sm:text-xl">{{ topic.icon }}</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-[#2d5a27] sm:text-base">{{ topic.name }}</h4>
                                <p class="text-xs text-gray-600">
                                    <span v-if="topicLoading && selectedTopic?.id === topic.id">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</span>
                                    <span v-else>{{ topic.count }}ржЯрж┐ ржЖржпрж╝рж╛ржд</span>
                                </p>
                            </div>
                        </div>
                        <p class="text-xs leading-relaxed text-gray-700 sm:text-sm">{{ topic.description }}</p>
                    </div>
                </div>
            </div>

            <!-- Memorization Helper Section -->
            <div
                class="mb-4 rounded-xl border border-[#5f5fcd]/10 bg-gradient-to-r from-[#5f5fcd]/5 via-white to-[#d4a574]/5 p-3 shadow-lg sm:mb-6 sm:rounded-2xl sm:p-4"
            >
                <div class="mb-3 flex items-center justify-between sm:mb-4">
                    <h3 class="flex items-center text-lg font-bold text-[#2d5a27] sm:text-xl">
                        <svg class="mr-2 h-5 w-5 sm:h-6 sm:w-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        рж╣рж┐ржлржп рж╕рж╣рж╛ржпрж╝ржХ
                    </h3>
                    <button
                        @click="showMemorizationHelper = !showMemorizationHelper"
                        class="flex items-center rounded-lg bg-[#5f5fcd]/15 px-3 py-1.5 font-semibold text-[#4A4A9E] transition-all duration-200 hover:bg-[#5f5fcd]/25 hover:text-[#383875]"
                    >
                        <span class="mr-1 text-sm font-medium">{{ showMemorizationHelper ? 'рж▓рзБржХрж╛ржи' : 'ржжрзЗржЦрзБржи' }}</span>
                        <svg
                            class="h-4 w-4 transition-transform duration-200"
                            :class="{ 'rotate-180': showMemorizationHelper }"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>

                <div v-if="showMemorizationHelper" class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3">
                    <!-- Progressive Revelation Mode -->
                    <div
                        @click="toggleProgressiveMode"
                        class="group cursor-pointer rounded-xl border p-3 transition-all duration-300 hover:scale-105 hover:transform sm:p-4"
                        :class="{
                            'border-[#5f5fcd] bg-gradient-to-br from-[#5f5fcd]/20 to-[#2d5a27]/20 shadow-lg': progressiveMode,
                            'border-[#5f5fcd]/20 bg-gradient-to-br from-white to-[#f8f9ff] hover:border-[#5f5fcd]/40 hover:shadow-md':
                                !progressiveMode,
                        }"
                    >
                        <div class="mb-2 flex items-center">
                            <div
                                class="mr-3 flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-[#5f5fcd] to-[#2d5a27] sm:h-10 sm:w-10"
                            >
                                <span class="text-lg sm:text-xl">ЁЯСБя╕П</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-[#2d5a27] sm:text-base">
                                    {{ progressiveMode ? 'ржкрзНрж░ржЧрзНрж░рзЗрж╕рж┐ржн ржорзЛржб ржЪрж╛рж▓рзБ' : 'ржкрзНрж░ржЧрзНрж░рзЗрж╕рж┐ржн ржорзЛржб' }}
                                </h4>
                                <p class="text-xs text-gray-600">{{ progressiveMode ? 'ржПржХржмрж╛рж░рзЗ ржПржХржЯрж┐ ржЖржпрж╝рж╛ржд' : 'ржПржХрзЗ ржПржХрзЗ ржЖржпрж╝рж╛ржд ржжрзЗржЦрзБржи' }}</p>
                            </div>
                        </div>
                        <p class="text-xs leading-relaxed text-gray-700 sm:text-sm">
                            {{ progressiveMode ? 'рж╕ржХрж▓ ржЖржпрж╝рж╛ржд ржПржХрж╕рж╛ржерзЗ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ' : 'рж╣рж┐ржлржп ржЕржирзБрж╢рзАрж▓ржирзЗрж░ ржЬржирзНржп ржПржХрзЗ ржПржХрзЗ ржЖржпрж╝рж╛ржд ржкрзНрж░ржжрж░рзНрж╢ржи' }}
                        </p>
                    </div>

                    <!-- Hide Translation Mode -->
                    <div
                        @click="toggleTranslationVisibility"
                        class="group cursor-pointer rounded-xl border p-3 transition-all duration-300 hover:scale-105 hover:transform sm:p-4"
                        :class="{
                            'border-[#d4a574] bg-gradient-to-br from-[#d4a574]/20 to-[#5f5fcd]/20 shadow-lg': hideTranslation,
                            'border-[#d4a574]/20 bg-gradient-to-br from-white to-[#f8f9ff] hover:border-[#d4a574]/40 hover:shadow-md':
                                !hideTranslation,
                        }"
                    >
                        <div class="mb-2 flex items-center">
                            <div
                                class="mr-3 flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-[#d4a574] to-[#5f5fcd] sm:h-10 sm:w-10"
                            >
                                <span class="text-lg sm:text-xl">ЁЯФд</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-[#2d5a27] sm:text-base">
                                    {{ hideTranslation ? 'ржЕржирзБржмрж╛ржж рж▓рзБржХрж╛ржирзЛ' : 'ржЕржирзБржмрж╛ржж рж▓рзБржХрж╛ржи' }}
                                </h4>
                                <p class="text-xs text-gray-600">{{ hideTranslation ? 'рж╢рзБржзрзБ ржЖрж░ржмрж┐ ржжрзЗржЦрж╛ржирзЛ' : 'рж╢рзБржзрзБ ржЖрж░ржмрж┐ ржкржбрж╝рзБржи' }}</p>
                            </div>
                        </div>
                        <p class="text-xs leading-relaxed text-gray-700 sm:text-sm">
                            {{ hideTranslation ? 'ржЕржирзБржмрж╛ржж ржЖржмрж╛рж░ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ' : 'рж╣рж┐ржлржп ржЕржирзБрж╢рзАрж▓ржирзЗрж░ ржЬржирзНржп ржЕржирзБржмрж╛ржж рж▓рзБржХрж┐ржпрж╝рзЗ рж░рж╛ржЦрзБржи' }}
                        </p>
                    </div>

                    <!-- Repeat Mode -->
                    <div
                        @click="toggleRepeatMode"
                        class="group cursor-pointer rounded-xl border p-3 transition-all duration-300 hover:scale-105 hover:transform sm:p-4"
                        :class="{
                            'border-[#2d5a27] bg-gradient-to-br from-[#2d5a27]/20 to-[#d4a574]/20 shadow-lg': repeatMode,
                            'border-[#2d5a27]/20 bg-gradient-to-br from-white to-[#f8f9ff] hover:border-[#2d5a27]/40 hover:shadow-md': !repeatMode,
                        }"
                    >
                        <div class="mb-2 flex items-center">
                            <div
                                class="mr-3 flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-[#2d5a27] to-[#d4a574] sm:h-10 sm:w-10"
                            >
                                <span class="text-lg sm:text-xl">ЁЯФД</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-[#2d5a27] sm:text-base">
                                    {{ repeatMode ? 'рж░рж┐ржкрж┐ржЯ ржорзЛржб ржЪрж╛рж▓рзБ' : 'рж░рж┐ржкрж┐ржЯ ржорзЛржб' }}
                                </h4>
                                <p class="text-xs text-gray-600">
                                    {{
                                        repeatMode && isPlaying && repeatCount > 0
                                            ? `ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐ ${toBanglaNumber(repeatCount)}/рзй`
                                            : repeatMode
                                              ? 'ржкрзНрж░рждрж┐ржЯрж┐ ржЖржпрж╝рж╛ржд ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐'
                                              : 'ржЖржпрж╝рж╛ржд ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐ ржХрж░рзБржи'
                                    }}
                                </p>
                            </div>
                        </div>
                        <p class="text-xs leading-relaxed text-gray-700 sm:text-sm">
                            {{ repeatMode ? 'ржкрзНрж░рждрж┐ржЯрж┐ ржЖржпрж╝рж╛ржд рзй ржмрж╛рж░ ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐ рж╣ржмрзЗ' : 'рж╣рж┐ржлржп ржЕржирзБрж╢рзАрж▓ржирзЗрж░ ржЬржирзНржп ржЖржпрж╝рж╛ржд ржкрзБржирж░рж╛ржмрзГрждрзНрждрж┐' }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Mobile-First Compact Selector -->
            <div
                class="mb-4 rounded-xl border border-[#5f5fcd]/10 bg-gradient-to-r from-[#5f5fcd]/5 via-white to-[#2d5a27]/5 p-3 shadow-lg sm:mb-8 sm:rounded-2xl sm:p-6"
            >
                <!-- Mobile: 2 rows, Tablet: 3 items per row, Desktop: All in one row -->
                <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 sm:gap-4 lg:grid-cols-6">
                    <!-- Surah Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            рж╕рзВрж░рж╛
                        </label>
                        <select
                            v-model="currentSurahNumber"
                            @change="selectSurah"
                            class="w-full rounded-lg border-2 border-[#5f5fcd]/20 bg-gradient-to-r from-white to-[#5f5fcd]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#5f5fcd]/40 hover:shadow-md focus:border-[#5f5fcd] focus:ring-2 focus:ring-[#5f5fcd]/30 sm:px-3 sm:text-sm"
                        >
                            <option v-for="surah in surahs" :key="surah.number" :value="surah.number">
                                {{ surah.number }}. {{ surah.banglaName }}
                            </option>
                        </select>
                    </div>

                    <!-- Juz/Para Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                                />
                            </svg>
                            ржкрж╛рж░рж╛
                        </label>
                        <select
                            v-model="selectedJuz"
                            @change="selectJuz"
                            class="w-full rounded-lg border-2 border-[#2d5a27]/20 bg-gradient-to-r from-white to-[#2d5a27]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#2d5a27]/40 hover:shadow-md focus:border-[#2d5a27] focus:ring-2 focus:ring-[#2d5a27]/30 sm:px-3 sm:text-sm"
                        >
                            <option :value="null">рж╕рзВрж░рж╛ ржжрж┐ржпрж╝рзЗ ржкржбрж╝рзБржи</option>
                            <option v-for="juz in availableJuzs" :key="juz.number" :value="juz.number">
                                {{ juz.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Reciter Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                                />
                            </svg>
                            ржХржгрзНржарж╕рзНржмрж░
                        </label>
                        <select
                            v-model="selectedReciter"
                            @change="updateReciter"
                            class="w-full rounded-lg border-2 border-[#d4a574]/20 bg-gradient-to-r from-white to-[#d4a574]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#d4a574]/40 hover:shadow-md focus:border-[#d4a574] focus:ring-2 focus:ring-[#d4a574]/30 sm:px-3 sm:text-sm"
                        >
                            <option v-for="reciter in availableReciters" :key="reciter.code" :value="reciter.code">
                                {{ reciter.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Translation Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H9.414l-2 2H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6.414l2-2H15a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6z"
                                />
                            </svg>
                            ржЕржирзБржмрж╛ржж
                        </label>
                        <select
                            v-model="selectedTranslation"
                            @change="updateTranslation"
                            class="w-full rounded-lg border-2 border-[#5f5fcd]/20 bg-gradient-to-r from-white to-[#5f5fcd]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#5f5fcd]/40 hover:shadow-md focus:border-[#5f5fcd] focus:ring-2 focus:ring-[#5f5fcd]/30 sm:px-3 sm:text-sm"
                        >
                            <option v-for="translation in availableTranslations" :key="translation.code" :value="translation.code">
                                {{ translation.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Arabic Text Style Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
                                />
                            </svg>
                            ржлржирзНржЯ
                        </label>
                        <select
                            v-model="selectedTextStyle"
                            @change="updateTextStyle"
                            class="w-full rounded-lg border-2 border-[#2d5a27]/20 bg-gradient-to-r from-white to-[#2d5a27]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#2d5a27]/40 hover:shadow-md focus:border-[#2d5a27] focus:ring-2 focus:ring-[#2d5a27]/30 sm:px-3 sm:text-sm"
                        >
                            <option v-for="textStyle in availableTextStyles" :key="textStyle.code" :value="textStyle.code">
                                {{ textStyle.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Page Selector -->
                    <div class="dropdown-container flex flex-col">
                        <label
                            class="islamic-pattern mb-1 flex items-center justify-center rounded-full px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:mb-2"
                        >
                            <svg class="mr-1 h-2.5 w-2.5 sm:h-3 sm:w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                />
                            </svg>
                            ржкрзГрж╖рзНржарж╛
                        </label>
                        <select
                            v-model="selectedPage"
                            @change="selectPage"
                            class="w-full rounded-lg border-2 border-[#5f5fcd]/20 bg-gradient-to-r from-white to-[#5f5fcd]/5 px-2 py-2 text-xs font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-[#5f5fcd]/40 hover:shadow-md focus:border-[#5f5fcd] focus:ring-2 focus:ring-[#5f5fcd]/30 sm:px-3 sm:text-sm"
                        >
                            <option :value="null">ржкрзГрж╖рзНржарж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</option>
                            <option v-for="page in availablePages" :key="page.number" :value="page.number">ржкрзГрж╖рзНржарж╛ {{ page.number }}</option>
                        </select>
                    </div>
                </div>

                <!-- Ultra-Compact Audio Controls -->
                <div class="mt-3 flex flex-wrap items-center justify-center gap-2 sm:mt-4">
                    <button
                        @click="toggleAudio"
                        :class="[
                            'flex items-center rounded-lg px-3 py-1.5 text-sm font-medium transition-all hover:shadow-md sm:px-4 sm:py-2',
                            isPlaying
                                ? 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'
                                : 'bg-gradient-to-r from-[#5f5fcd] to-[#2d5a27] text-white',
                        ]"
                    >
                        <component :is="isPlaying ? PauseIcon : PlayIcon" class="mr-1 h-3 w-3 sm:mr-2 sm:h-4 sm:w-4" />
                        <span class="hidden sm:inline">{{
                            isPlaying ? 'ржерж╛ржорж╛ржи' : currentJuz ? 'ржкрж╛рж░рж╛ ржерзЗржХрзЗ ржЪрж╛рж▓рж╛ржи' : selectedPage ? 'ржкрзГрж╖рзНржарж╛ ржерзЗржХрзЗ ржЪрж╛рж▓рж╛ржи' : 'рждрзЗрж▓рж╛ржУржпрж╝рж╛ржд рж╢рзБржирзБржи'
                        }}</span>
                        <span class="sm:hidden">{{ isPlaying ? 'ржерж╛ржорж╛ржи' : 'ржЪрж╛рж▓рж╛ржи' }}</span>
                    </button>
                </div>
            </div>

            <!-- Ultra-Compact Info Badges -->
            <div v-if="currentSurah || currentJuz || selectedPage" class="mb-3 flex flex-wrap justify-center gap-2 sm:mb-4">
                <!-- Surah Badge -->
                <div v-if="currentSurah" class="flex items-center rounded-full bg-gradient-to-r from-[#5f5fcd]/10 to-[#2d5a27]/10 px-3 py-1.5">
                    <span class="text-sm font-semibold text-[#2d5a27]"> рж╕рзВрж░рж╛ {{ currentSurah.banglaName }} </span>
                    <span class="ml-2 text-xs text-gray-600">
                        {{ currentSurah.revelationType === 'Meccan' ? 'ржоржХрзНржХрзА' : 'ржорж╛ржжрж╛ржирзА' }} тАв {{ currentSurah.numberOfAyahs }} ржЖржпрж╝рж╛ржд
                    </span>
                </div>

                <!-- Juz Badge -->
                <div v-if="currentJuz" class="flex items-center rounded-full bg-gradient-to-r from-[#2d5a27]/10 to-[#5f5fcd]/10 px-3 py-1.5">
                    <span class="text-sm font-semibold text-[#2d5a27]">
                        {{ currentJuz.name }}
                    </span>
                    <span class="ml-2 text-xs text-gray-600"> {{ currentJuz.arabicName }} тАв {{ ayahs.length }} ржЖржпрж╝рж╛ржд </span>
                </div>

                <!-- Page Badge -->
                <div v-if="selectedPage" class="flex items-center rounded-full bg-gradient-to-r from-[#5f5fcd]/10 to-[#d4a574]/10 px-3 py-1.5">
                    <span class="text-sm font-semibold text-[#2d5a27]"> ржкрзГрж╖рзНржарж╛ {{ selectedPage }} </span>
                    <span class="ml-2 text-xs text-gray-600"> {{ ayahs.length }} ржЖржпрж╝рж╛ржд </span>
                </div>

                <!-- Compact Bismillah -->
                <div
                    v-if="currentSurah && currentSurah.number !== 9"
                    class="flex items-center rounded-full bg-gradient-to-r from-[#d4a574]/10 to-[#5f5fcd]/10 px-3 py-1.5"
                >
                    <span class="font-arabic text-sm text-[#5f5fcd]" dir="rtl"> ╪и┘Р╪│┘Т┘Е┘Р ╪з┘Д┘Д┘О┘С┘З┘Р ╪з┘Д╪▒┘О┘С╪н┘Т┘Е┘О┘░┘Ж┘Р ╪з┘Д╪▒┘О┘С╪н┘Р┘К┘Е┘Р </span>
                </div>
            </div>

            <!-- Topic Loading State -->
            <div v-if="topicLoading" class="mb-4 text-center sm:mb-6">
                <div
                    class="inline-flex items-center rounded-full border border-[#d4a574]/20 bg-gradient-to-r from-[#d4a574]/10 to-[#5f5fcd]/10 px-4 py-2"
                >
                    <div class="mr-2 h-5 w-5 animate-spin rounded-full border-b-2 border-[#d4a574]"></div>
                    <span class="font-semibold text-[#2d5a27]"> {{ selectedTopic?.name || 'ржмрж┐рж╖ржпрж╝' }} ржПрж░ ржЖржпрж╝рж╛ржд ржЦрзБржБржЬрзЗ ржЖржирж╛ рж╣ржЪрзНржЫрзЗ... </span>
                </div>
            </div>

            <!-- Topic Results Header -->
            <div v-if="topicResults.length > 0 && !topicLoading" class="mb-4 text-center sm:mb-6">
                <div
                    class="inline-flex items-center rounded-full border border-[#d4a574]/20 bg-gradient-to-r from-[#d4a574]/10 to-[#5f5fcd]/10 px-4 py-2"
                >
                    <span class="mr-2 text-lg">{{ selectedTopic.icon }}</span>
                    <span class="font-semibold text-[#2d5a27]"> {{ selectedTopic.name }} - {{ topicResults.length }}ржЯрж┐ ржЖржпрж╝рж╛ржд ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ </span>
                    <button
                        @click="clearTopic"
                        class="ml-3 rounded-full bg-[#d4a574]/10 px-2 py-1 text-sm text-[#d4a574] transition-all hover:bg-[#d4a574]/20"
                    >
                        тЬХ
                    </button>
                </div>
            </div>

            <!-- Search Results Header -->
            <div v-if="searchResults.length > 0 && !selectedTopic" class="mb-4 text-center sm:mb-6">
                <div
                    class="inline-flex items-center rounded-full border border-[#5f5fcd]/20 bg-gradient-to-r from-[#5f5fcd]/10 to-[#2d5a27]/10 px-4 py-2"
                >
                    <svg class="mr-2 h-5 w-5 text-[#5f5fcd]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span class="font-semibold text-[#2d5a27]"> "{{ searchQuery }}" ржПрж░ ржЬржирзНржп {{ searchResults.length }}ржЯрж┐ ржлрж▓рж╛ржлрж▓ ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ </span>
                </div>
            </div>

            <!-- No Search Results -->
            <div v-if="searchQuery.trim() && searchResults.length === 0 && !searchLoading" class="py-8 text-center sm:py-12">
                <div class="rounded-xl border border-[#d4a574]/20 bg-gradient-to-r from-[#d4a574]/10 to-[#5f5fcd]/10 p-6 sm:p-8">
                    <svg class="mx-auto mb-4 h-12 w-12 text-[#d4a574] sm:h-16 sm:w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <h3 class="mb-2 text-lg font-semibold text-[#2d5a27] sm:text-xl">ржХрзЛржи ржлрж▓рж╛ржлрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐</h3>
                    <p class="text-sm text-gray-600 sm:text-base">
                        "{{ searchQuery }}" ржПрж░ ржЬржирзНржп ржХрзЛржи ржЖржпрж╝рж╛ржд ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред ржЕржирзНржп ржХрж┐ржЫрзБ ржЕржирзБрж╕ржирзНржзрж╛ржи ржХрж░рзЗ ржжрзЗржЦрзБржиред
                    </p>
                </div>
            </div>

            <!-- Progressive Mode Controls -->
            <div v-if="progressiveMode && ayahs.length > 0" class="mb-4 flex justify-center sm:mb-6">
                <div
                    class="inline-flex items-center rounded-xl border border-[#5f5fcd]/20 bg-gradient-to-r from-[#5f5fcd]/10 to-[#2d5a27]/10 p-3 shadow-lg sm:p-4"
                >
                    <button
                        @click="prevAyah"
                        :disabled="currentAyahIndex === 0"
                        class="mr-4 flex items-center rounded-lg bg-[#5f5fcd]/20 px-3 py-2 text-[#5f5fcd] transition-all duration-200 hover:bg-[#5f5fcd]/30 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        <svg class="mr-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        ржЖржЧрзЗрж░
                    </button>

                    <div class="mx-4 flex items-center">
                        <span class="font-bold text-[#2d5a27]"> {{ currentAyahIndex + 1 }} / {{ ayahs.length }} </span>
                        <span class="ml-2 text-sm text-gray-600">ржЖржпрж╝рж╛ржд</span>
                    </div>

                    <button
                        @click="nextAyah"
                        :disabled="currentAyahIndex === ayahs.length - 1"
                        class="ml-4 flex items-center rounded-lg bg-[#2d5a27]/20 px-3 py-2 text-[#2d5a27] transition-all duration-200 hover:bg-[#2d5a27]/30 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                        ржкрж░рзЗрж░
                        <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Topic Loading Indicator -->
            <div v-if="topicLoading && selectedTopic" class="flex flex-col items-center justify-center py-12">
                <div class="relative">
                    <div class="flex h-16 w-16 animate-pulse items-center justify-center rounded-full bg-gradient-to-br from-[#d4a574] to-[#5f5fcd]">
                        <span class="text-2xl">{{ selectedTopic.icon }}</span>
                    </div>
                    <div class="absolute inset-0 animate-ping">
                        <div class="h-16 w-16 rounded-full border-2 border-[#d4a574] opacity-30"></div>
                    </div>
                </div>
                <p class="mt-4 text-lg font-medium text-[#2d5a27]">{{ selectedTopic.name }} ржПрж░ ржЖржпрж╝рж╛ржд ржЦрзБржБржЬрзЗ ржЖржирж╛ рж╣ржЪрзНржЫрзЗ...</p>
                <p class="mt-2 text-sm text-gray-600">ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи</p>
            </div>

            <!-- Premium Ayahs Display -->
            <div v-if="displayAyahs.length > 0 && !topicLoading" class="space-y-4 sm:space-y-6">
                <div
                    v-for="ayah in displayAyahs"
                    :key="ayah.numberInSurah"
                    class="group relative overflow-hidden rounded-2xl border border-[#5f5fcd]/10 bg-gradient-to-br from-white via-[#f8f9ff] to-[#f0f7f0] p-4 shadow-lg transition-all duration-500 hover:scale-[1.01] hover:transform hover:border-[#5f5fcd]/20 hover:shadow-xl sm:rounded-3xl sm:p-6"
                >
                    <!-- Subtle Background Pattern -->
                    <div class="absolute inset-0 opacity-[0.02]">
                        <div
                            class="absolute top-0 right-0 h-32 w-32 translate-x-16 -translate-y-16 transform rounded-full bg-gradient-to-br from-[#5f5fcd] to-[#2d5a27] blur-3xl"
                        ></div>
                        <div
                            class="absolute bottom-0 left-0 h-24 w-24 -translate-x-12 translate-y-12 transform rounded-full bg-gradient-to-tr from-[#d4a574] to-[#5f5fcd] blur-2xl"
                        ></div>
                    </div>

                    <!-- Enhanced Header -->
                    <div class="relative z-10 mb-4 flex items-center justify-between sm:mb-6">
                        <div class="flex items-center space-x-3 sm:space-x-4">
                            <!-- Premium Ayah Number Badge -->
                            <div class="relative">
                                <div
                                    class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-[#5f5fcd] via-[#4a4aa6] to-[#2d5a27] shadow-lg sm:h-10 sm:w-10"
                                >
                                    <span class="text-sm font-bold text-white sm:text-base">{{ ayah.numberInSurah }}</span>
                                </div>
                                <div class="absolute -inset-1 rounded-full bg-gradient-to-r from-[#5f5fcd] to-[#2d5a27] opacity-20 blur"></div>
                            </div>

                            <!-- Ayah Info -->
                            <div class="space-y-1">
                                <div class="flex items-center space-x-2 text-sm sm:text-base">
                                    <span
                                        v-if="currentJuz"
                                        class="rounded-full bg-[#2d5a27]/10 px-2 py-1 text-xs font-semibold text-[#2d5a27] sm:text-sm"
                                    >
                                        {{ ayah.surah.englishName }}
                                    </span>
                                    <span class="font-bold text-[#5f5fcd]">ржЖржпрж╝рж╛ржд {{ ayah.numberInSurah }}</span>
                                </div>
                                <div v-if="currentJuz" class="text-xs text-gray-500">
                                    {{ ayah.surah.revelationType === 'Meccan' ? 'ржоржХрзНржХрзА' : 'ржорж╛ржжрж╛ржирзА' }}
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Copy Button -->
                        <div class="flex items-center">
                            <button
                                @click="copyAyah(ayah, $event)"
                                class="group/copy flex items-center rounded-xl border border-[#5f5fcd]/20 bg-gradient-to-r from-[#5f5fcd]/10 via-[#5f5fcd]/5 to-[#2d5a27]/10 px-3 py-2 shadow-sm transition-all duration-300 hover:border-[#5f5fcd]/40 hover:from-[#5f5fcd]/20 hover:to-[#2d5a27]/20 hover:shadow-md sm:px-4 sm:py-2.5"
                                title="ржЖржпрж╝рж╛ржд ржХржкрж┐ ржХрж░рзБржи"
                            >
                                <svg
                                    class="mr-2 h-4 w-4 text-[#5f5fcd] transition-transform group-hover/copy:scale-110 sm:h-5 sm:w-5"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
                                    <path
                                        d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11.586l-3-3a1 1 0 00-1.414 1.414L11.586 11H15V11.586z"
                                    />
                                </svg>
                                <span class="text-sm font-semibold text-[#5f5fcd] group-hover/copy:text-[#4a4aa6] sm:text-base">ржХржкрж┐</span>
                            </button>
                        </div>
                    </div>

                    <!-- Premium Arabic Text -->
                    <div
                        class="relative z-10 mb-4 rounded-2xl border border-[#5f5fcd]/20 bg-gradient-to-br from-[#5f5fcd]/8 via-white to-[#2d5a27]/8 p-5 shadow-inner sm:mb-6 sm:p-8"
                        dir="rtl"
                    >
                        <div
                            class="font-arabic text-center text-xl leading-[1.8] font-medium text-[#2d5a27] selection:bg-[#5f5fcd]/20 selection:text-[#2d5a27] sm:text-2xl sm:leading-[1.9] md:text-3xl lg:text-4xl lg:leading-[2.0]"
                        >
                            {{ ayah.arabicText || ayah.text }}
                        </div>
                        <!-- Subtle shine effect -->
                        <div
                            class="absolute inset-0 rounded-2xl bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 transition-opacity duration-700 group-hover:opacity-100"
                        ></div>
                    </div>

                    <!-- Enhanced Bengali Translation -->
                    <div v-if="!hideTranslation && (ayah.translationText || ayahTranslations[ayah.numberInSurah])" class="relative z-10 text-center">
                        <div
                            class="relative rounded-xl border border-[#d4a574]/10 bg-gradient-to-r from-[#d4a574]/5 via-[#f8f9ff] to-[#d4a574]/5 p-4 shadow-sm sm:p-6"
                        >
                            <div
                                class="text-base leading-relaxed font-medium text-gray-700 selection:bg-[#d4a574]/20 selection:text-gray-800 sm:text-lg"
                            >
                                <span class="text-lg text-[#d4a574] sm:text-xl">"</span>
                                {{ ayah.translationText || ayahTranslations[ayah.numberInSurah] }}
                                <span class="text-lg text-[#d4a574] sm:text-xl">"</span>
                            </div>
                            <!-- Quote decoration -->
                            <div class="absolute top-2 left-2 h-2 w-2 rounded-full bg-[#d4a574]/20"></div>
                            <div class="absolute right-2 bottom-2 h-2 w-2 rounded-full bg-[#d4a574]/20"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Element -->
            <audio
                ref="audioElement"
                @play="isPlaying = true"
                @pause="isPlaying = false"
                @ended="handleAudioEnded"
                @error="handleAudioError"
                preload="metadata"
                style="display: none"
            ></audio>
        </div>
    </FrontendLayout>
</template>

<script setup>
import FrontendLayout from '@/layouts/FrontendLayout.vue';
import { Head } from '@inertiajs/vue3';
import { PauseIcon, PlayIcon } from 'lucide-vue-next';
import { computed, onMounted, ref } from 'vue';

// Simple state
const surahs = ref([]);
const currentSurahNumber = ref(1);
const currentSurah = ref(null);
const currentJuz = ref(null);
const ayahs = ref([]);
const ayahTranslations = ref({});
const isPlaying = ref(false);
const audioElement = ref(null);
const selectedReciter = ref('afs');
const availableReciters = ref([
    { code: 'afs', name: 'ржЖрж▓-ржЖржлрж╛рж╕рж┐ (Al-Afasy)', server: 'server8.mp3quran.net/afs' },
    { code: 'thubti', name: 'рж╕рж╛ржЙржж ржЖрж╢-рж╢рзБрж░рж╛ржЗржо (As-Shuraim)', server: 'server6.mp3quran.net/thubti' },
    { code: 'minsh', name: 'ржорж┐рж╢рж╛рж░рж┐ ржЖрж▓-ржЖржлрж╛рж╕рж┐ (Mishary)', server: 'server10.mp3quran.net/minsh' },
    { code: 'husary', name: 'ржорж╛рж╣ржорзБржж ржЦрж▓рж┐рж▓ ржЖрж▓-рж╣рзБрж╕рж╛рж░рж┐ (Al-Husary)', server: 'server13.mp3quran.net/husr' },
    { code: 'maher', name: 'ржорж╛рж╣рзЗрж░ ржЖрж▓-ржорзБржпрж╝рж╛ржЗржХрж▓рж┐ (Maher Al-Muaiqly)', server: 'server12.mp3quran.net/maher' },
]);

const selectedTranslation = ref('bn.bengali');
const availableTranslations = ref([
    { code: 'bn.bengali', name: 'ржорзБрж╣рж┐ржЙржжрзНржжрзАржи ржЦрж╛ржи', author: 'Muhiuddin Khan' },
    { code: 'bn.hoque', name: 'ржЬрж╣рзБрж░рзБрж▓ рж╣ржХ', author: 'Jahorul Hoque' },
]);

const selectedTextStyle = ref('quran-uthmani');
const availableTextStyles = ref([
    { code: 'quran-uthmani', name: 'ржЙрж╕ржорж╛ржирж┐ (ржРрждрж┐рж╣рзНржпржмрж╛рж╣рзА)', description: 'Traditional Uthmani script' },
    { code: 'quran-simple', name: 'рж╕рж░рж▓ (рждрж╛рж╢ржХрж┐рж▓ рж╕рж╣)', description: 'Simple with Tashkeel' },
    { code: 'quran-simple-clean', name: 'рж╕рж░рж▓ ржХрзНрж▓рж┐ржи (рждрж╛рж╢ржХрж┐рж▓ ржЫрж╛ржбрж╝рж╛)', description: 'Simple without Tashkeel' },
    { code: 'quran-tajweed', name: 'рждрж╛ржЬржЙржЗржж (рж░ржЩрж┐ржи)', description: 'Colored for Tajweed rules' },
]);

const selectedJuz = ref(null);
const availableJuzs = ref([
    { number: 1, name: 'рззржо ржкрж╛рж░рж╛', arabicName: '╪з┘Д█д┘Е█д' },
    { number: 2, name: 'рзиржпрж╝ ржкрж╛рж░рж╛', arabicName: '╪│┘О┘К┘О┘В┘П┘И┘Д┘П' },
    { number: 3, name: 'рзйржпрж╝ ржкрж╛рж░рж╛', arabicName: '╪к┘Р┘Д█б┘Г┘О ╪з┘Д╪▒┘П┘С╪│┘П┘Д┘П' },
    { number: 4, name: 'рзкрж░рзНрже ржкрж╛рж░рж╛', arabicName: '┘Д┘О┘Ж ╪к┘О┘Ж┘О╪з┘Д┘П┘И╪з█Я' },
    { number: 5, name: 'рзлржо ржкрж╛рж░рж╛', arabicName: '┘И┘О╪з┘Д█б┘Е┘П╪н█б╪╡┘О┘Ж┘░╪к┘П' },
    { number: 6, name: 'рзмрж╖рзНржа ржкрж╛рж░рж╛', arabicName: '┘Д┘О╪з ┘К┘П╪н┘Р╪и┘П┘С ╪з┘Д┘Д┘О┘С┘З┘П' },
    { number: 7, name: 'рзнржо ржкрж╛рж░рж╛', arabicName: '┘И┘О╪е┘Р╪░┘О╪з ╪│┘О┘Е┘Р╪╣┘П┘И╪з█Я' },
    { number: 8, name: 'рзоржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘Д┘О┘И█б ╪г┘О┘Ж┘О┘С┘Ж┘О╪з' },
    { number: 9, name: 'рзпржо ржкрж╛рж░рж╛', arabicName: '┘В┘О╪з┘Д┘О ╪з┘Д█б┘Е┘О┘Д┘О╪д┘П╪з█Я' },
    { number: 10, name: 'рззрзжржо ржкрж╛рж░рж╛', arabicName: '┘И┘О╪з╪╣█б┘Д┘О┘Е┘П┘И█д╪з█Я' },
    { number: 11, name: 'рззрззржо ржкрж╛рж░рж╛', arabicName: '┘К┘О╪╣█б╪к┘О╪░┘Р╪▒┘П┘И┘Ж┘О' },
    { number: 12, name: 'рззрзиржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘Е┘О╪з ┘Е┘Р┘Ж ╪п┘О╪в╪и┘О┘С╪й┘Н' },
    { number: 13, name: 'рззрзйржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘Е┘О╪з ╪г┘П╪и┘О╪▒┘Р┘С╪ж┘П' },
    { number: 14, name: 'рззрзкржо ржкрж╛рж░рж╛', arabicName: '╪▒┘П┘С╪и┘О┘Е┘О╪з' },
    { number: 15, name: 'рззрзлржо ржкрж╛рж░рж╛', arabicName: '╪│┘П╪и█б╪н┘О╪з┘Ж┘О ╪з┘Д┘О┘С╪░┘Р┘Й█д' },
    { number: 16, name: 'рззрзмржо ржкрж╛рж░рж╛', arabicName: '┘В┘О╪з┘Д┘О ╪г┘О┘Д┘О┘Е█б' },
    { number: 17, name: 'рззрзнржо ржкрж╛рж░рж╛', arabicName: '╪з┘В█б╪к┘О╪▒┘О╪и┘О ┘Д┘Р┘Д┘Ж┘О┘С╪з╪│┘Р' },
    { number: 18, name: 'рззрзоржо ржкрж╛рж░рж╛', arabicName: '┘В┘О╪п█б ╪г┘О┘Б█б┘Д┘О╪н┘О' },
    { number: 19, name: 'рззрзпржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘В┘О╪з┘Д┘О ╪з┘Д┘О┘С╪░┘Р┘К┘Ж┘О' },
    { number: 20, name: 'рзирзжржо ржкрж╛рж░рж╛', arabicName: '╪г┘О┘Е┘О┘С┘Ж█б ╪о┘О┘Д┘О┘В┘О' },
    { number: 21, name: 'рзирззржо ржкрж╛рж░рж╛', arabicName: '╪з╪к█б┘Д┘П ┘Е┘О╪з ╪г┘П┘И╪н┘Р┘К┘О' },
    { number: 22, name: 'рзирзиржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘Е┘О┘Ж ┘К┘О┘С┘В█б┘Ж┘П╪к█б' },
    { number: 23, name: 'рзирзйржо ржкрж╛рж░рж╛', arabicName: '┘И┘О┘Е┘О╪в ╪г┘О┘Ж╪▓┘О┘Д█б┘Ж┘О╪з' },
    { number: 24, name: 'рзирзкржо ржкрж╛рж░рж╛', arabicName: '┘Б┘О┘Е┘О┘Ж█б ╪г┘О╪╕█б┘Д┘О┘Е┘П' },
    { number: 25, name: 'рзирзлржо ржкрж╛рж░рж╛', arabicName: '╪е┘Р┘Д┘О┘К█б┘З┘Р ┘К┘П╪▒┘О╪п┘П┘С' },
    { number: 26, name: 'рзирзмржо ржкрж╛рж░рж╛', arabicName: '╪н┘░┘Е┘У' },
    { number: 27, name: 'рзирзнржо ржкрж╛рж░рж╛', arabicName: '┘В┘О╪з┘Д┘О ┘Б┘О┘Е┘О╪з ╪о┘О╪╖█б╪и┘П┘Г┘П┘Е█б' },
    { number: 28, name: 'рзирзоржо ржкрж╛рж░рж╛', arabicName: '┘В┘О╪п█б ╪│┘О┘Е┘Р╪╣┘О' },
    { number: 29, name: 'рзирзпржо ржкрж╛рж░рж╛', arabicName: '╪к┘О╪и┘О╪з╪▒┘О┘Г┘О ╪з┘Д┘О┘С╪░┘Р┘Й' },
    { number: 30, name: 'рзйрзжржо ржкрж╛рж░рж╛', arabicName: '╪╣┘О┘Е┘О┘С ┘К┘О╪к┘О╪│┘О╪в╪б┘О┘Д┘П┘И┘Ж┘О' },
]);

const selectedPage = ref(null);
const availablePages = ref([]);

// Generate page numbers (1-604 for standard Quran mushaf)
const generatePageNumbers = () => {
    const pages = [];
    for (let i = 1; i <= 604; i++) {
        pages.push({ number: i });
    }
    return pages;
};

// Search functionality
const searchQuery = ref('');
const searchResults = ref([]);
const searchLoading = ref(false);
const searchIn = ref('all'); // 'all' or 'current'
const searchLanguage = ref('arabic'); // 'arabic' or 'bengali'

// Topic-Based Study
const showTopics = ref(false);
const selectedTopic = ref(null);
const topicResults = ref([]);
const topicLoading = ref(false);

// Cache for API results
const apiCache = new Map();
const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

// Advanced Search & Discovery
const conceptSuggestions = ref([]);
const searchHistory = ref([]);
const similarAyahs = ref([]);
const showSimilarAyahs = ref(false);

// Memorization Helper
const showMemorizationHelper = ref(false);
const progressiveMode = ref(false);
const hideTranslation = ref(false);
const repeatMode = ref(false);
const currentAyahIndex = ref(0);
const repeatCount = ref(0);
const maxRepeats = ref(3);

// Topic Categories with search terms
const topicCategories = ref([
    {
        id: 'salah',
        name: 'ржирж╛ржорж╛ржЬ ржУ ржЗржмрж╛ржжржд',
        icon: 'ЁЯд▓',
        count: 67,
        description: 'ржирж╛ржорж╛ржЬ, ржжрзЛржпрж╝рж╛, ржпрж┐ржХрж┐рж░ ржПржмржВ ржЗржмрж╛ржжржд рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪╡┘Д╪з╪й', '╪╡┘Д', '╪╡┘Д┘И╪з', '╪з╪╣╪и╪п', '╪╣╪и╪з╪п╪й', '┘Ж╪│┘Г', '╪п╪╣┘И╪й', '╪з╪│╪к╪║┘Б╪▒', '╪к╪│╪и┘К╪н'],
    },
    {
        id: 'zakat',
        name: 'ржпрж╛ржХрж╛ржд ржУ ржжрж╛ржирж╢рзАрж▓рждрж╛',
        icon: 'ЁЯТ░',
        count: 32,
        description: 'ржпрж╛ржХрж╛ржд, ржжрж╛ржи, рж╕рж╛ржжржХрж╛ ржПржмржВ ржжрж╛ржирж╢рзАрж▓рждрж╛ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪▓┘Г╪з╪й', '╪▓┘Г┘И╪з', '╪╡╪п┘В╪й', '╪з┘Ж┘Б┘В', '╪з┘Ж┘Б╪з┘В', '╪з╪╣╪╖┘Й', '╪и╪▒╪▒', '╪о┘К╪▒'],
    },
    {
        id: 'hajj',
        name: 'рж╣ржЬ ржУ ржЙржорж░рж╛',
        icon: 'ЁЯХЛ',
        count: 15,
        description: 'рж╣ржЬ, ржЙржорж░рж╛, ржХрж╛ржмрж╛ ржПржмржВ ржкржмрж┐рждрзНрж░ рж╕рзНржерж╛ржи рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪н╪м', '╪╣┘Е╪▒╪й', '┘Г╪╣╪и╪й', '╪и┘К╪к', '┘Е┘Г╪й', '┘Е╪│╪м╪п', '╪н╪▒╪з┘Е', '┘Е┘Ж╪│┘Г'],
    },
    {
        id: 'patience',
        name: 'ржзрзИрж░рзНржп ржУ рж╕ржмрж░',
        icon: 'ЁЯМ╕',
        count: 90,
        description: 'ржзрзИрж░рзНржп, рж╕ржмрж░, ржХрж╖рзНржЯ ржПржмржВ ржкрж░рзАржХрзНрж╖рж╛ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪╡╪и╪▒', '╪з╪╡╪и╪▒', '╪╡╪з╪и╪▒', '╪╡╪з╪и╪▒┘К┘Ж', '╪и┘Д╪з╪б', '┘Б╪к┘Ж╪й', '╪з┘Е╪к╪н╪з┘Ж', '╪з╪и╪к┘Д┘Й'],
    },
    {
        id: 'prophets',
        name: 'ржиржмрзА-рж░рж╛рж╕рзВрж▓ржжрзЗрж░ ржХрж╛рж╣рж┐ржирзА',
        icon: 'ЁЯСе',
        count: 156,
        description: 'рж╣ржпрж░ржд ржЖржжржо ржерзЗржХрзЗ ржорзБрж╣рж╛ржорзНржоржж (рж╕рж╛.) ржкрж░рзНржпржирзНржд рж╕ржХрж▓ ржиржмрзАржжрзЗрж░ ржХрж╛рж╣рж┐ржирзА',
        searchTerms: ['┘Ж╪и┘К', '╪▒╪│┘И┘Д', '╪в╪п┘Е', '┘Ж┘И╪н', '╪е╪и╪▒╪з┘З┘К┘Е', '┘Е┘И╪│┘Й', '╪╣┘К╪│┘Й', '┘Е╪н┘Е╪п', '┘К┘И╪│┘Б', '╪п╪з┘И╪п', '╪│┘Д┘К┘Е╪з┘Ж'],
    },
    {
        id: 'paradise',
        name: 'ржЬрж╛ржирзНржирж╛ржд ржУ ржЬрж╛рж╣рж╛ржирзНржирж╛ржо',
        icon: 'ЁЯМ╣',
        count: 77,
        description: 'ржЬрж╛ржирзНржирж╛ржд, ржЬрж╛рж╣рж╛ржирзНржирж╛ржо, ржкрж░ржХрж╛рж▓ ржПржмржВ ржкрзБрж░рж╕рзНржХрж╛рж░ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪м┘Ж╪й', '╪м┘Ж╪з╪к', '┘Ж╪з╪▒', '╪м┘З┘Ж┘Е', '╪╣╪░╪з╪и', '╪л┘И╪з╪и', '╪з╪м╪▒', '╪▒╪н┘Е╪й'],
    },
    {
        id: 'family',
        name: 'ржкрж░рж┐ржмрж╛рж░ ржУ рж╕ржорж╛ржЬ',
        icon: 'ЁЯСк',
        count: 45,
        description: 'ржкрж╛рж░рж┐ржмрж╛рж░рж┐ржХ рж╕ржорзНржкрж░рзНржХ, ржкрж┐рждрж╛-ржорж╛рждрж╛, рж╕ржирзНрждрж╛ржи ржПржмржВ рж╕ржорж╛ржЬ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['┘И╪з┘Д╪п┘К┘Ж', '╪з╪и', '╪з┘Е', '╪и┘Ж┘К┘Ж', '╪▓┘И╪м', '╪з┘З┘Д', '┘В╪▒╪з╪и╪й', '╪▒╪н┘Е'],
    },
    {
        id: 'knowledge',
        name: 'ржЬрзНржЮрж╛ржи ржУ рж╢рж┐ржХрзНрж╖рж╛',
        icon: 'ЁЯУЪ',
        count: 54,
        description: 'ржЬрзНржЮрж╛ржи, рж╢рж┐ржХрзНрж╖рж╛, ржмрзБржжрзНржзрж┐ржорждрзНрждрж╛ ржПржмржВ ржЪрж┐ржирзНрждрж╛ржнрж╛ржмржирж╛ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪╣┘Д┘Е', '╪╣╪з┘Д┘Е', '╪╣┘Д┘Е╪з╪б', '╪н┘Г┘Е╪й', '┘Б┘В┘З', '┘Б┘Г╪▒', '╪╣┘В┘Д', '╪к╪п╪и╪▒'],
    },
    {
        id: 'forgiveness',
        name: 'ржХрзНрж╖ржорж╛ ржУ рждржУржмрж╛',
        icon: 'ЁЯХКя╕П',
        count: 88,
        description: 'ржХрзНрж╖ржорж╛, рждржУржмрж╛, ржЕржирзБрж╢рзЛржЪржирж╛ ржПржмржВ ржорж╛ржл рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪║┘Б╪▒', '╪║┘Б┘И╪▒', '┘Е╪║┘Б╪▒╪й', '╪к┘И╪и╪й', '╪к╪з╪и', '╪з╪│╪к╪║┘Б╪з╪▒', '╪╣┘Б┘И', '╪▒╪н┘К┘Е'],
    },
    {
        id: 'guidance',
        name: 'рж╣рж┐ржжрж╛ржпрж╝рж╛ржд ржУ ржкржержкрзНрж░ржжрж░рзНрж╢ржи',
        icon: 'ЁЯМЯ',
        count: 63,
        description: 'рж╣рж┐ржжрж╛ржпрж╝рж╛ржд, рж╕рждрзНржп ржкрже, ржкржержкрзНрж░ржжрж░рзНрж╢ржи ржПржмржВ рж╕ржарж┐ржХ ржжрж┐ржХ рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['┘З╪п┘Й', '┘З╪п╪з┘К╪й', '╪╡╪▒╪з╪╖', '╪╖╪▒┘К┘В', '╪│╪и┘К┘Д', '┘Ж┘И╪▒', '╪и╪╡┘К╪▒╪й', '╪▒╪┤╪п'],
    },
    {
        id: 'allah_names',
        name: 'ржЖрж▓рзНрж▓рж╛рж╣рж░ ржирж╛ржо ржУ ржЧрзБржгрж╛ржмрж▓рзА',
        icon: 'тЬи',
        count: 99,
        description: 'ржЖрж╕ржорж╛ржЙрж▓ рж╣рзБрж╕ржирж╛ - ржЖрж▓рзНрж▓рж╛рж╣рж░ рзпрзпржЯрж┐ ржирж╛ржо ржПржмржВ ржЧрзБржгрж╛ржмрж▓рзА',
        searchTerms: ['╪з┘Д┘Д┘З', '╪▒╪н┘Е┘Ж', '╪▒╪н┘К┘Е', '┘Е┘Д┘Г', '┘В╪п┘И╪│', '╪│┘Д╪з┘Е', '╪╣╪▓┘К╪▓', '╪║┘Б╪з╪▒', '┘В┘З╪з╪▒', '┘И┘З╪з╪и'],
    },
    {
        id: 'creation',
        name: 'рж╕рзГрж╖рзНржЯрж┐ ржУ ржкрзНрж░ржХрзГрждрж┐',
        icon: 'ЁЯМН',
        count: 41,
        description: 'рж╕рзГрж╖рзНржЯрж┐ржЬржЧржд, ржкрзНрж░ржХрзГрждрж┐, ржЖржХрж╛рж╢-ржкрзГржерж┐ржмрзА ржПржмржВ ржорж╣рж╛ржмрж┐рж╢рзНржм рж╕ржорзНржкрж░рзНржХрж┐ржд ржЖржпрж╝рж╛ржд',
        searchTerms: ['╪о┘Д┘В', '╪о╪з┘Д┘В', '╪│┘Е╪з╪б', '╪з╪▒╪╢', '╪┤┘Е╪│', '┘В┘Е╪▒', '┘Ж╪м┘Е', '╪и╪н╪▒', '╪м╪и╪з┘Д'],
    },
]);

// Computed property to determine which ayahs to display
const displayAyahs = computed(() => {
    let ayahsToShow = [];

    if (topicResults.value.length > 0) {
        ayahsToShow = topicResults.value;
    } else if (searchResults.value.length > 0) {
        ayahsToShow = searchResults.value;
    } else {
        ayahsToShow = ayahs.value;
    }

    // Apply progressive mode filter
    if (progressiveMode.value && ayahsToShow.length > 0) {
        // Show only the current ayah and all previous ones
        return ayahsToShow.slice(0, currentAyahIndex.value + 1);
    }

    return ayahsToShow;
});

// Search functions
const performSearch = async () => {
    if (!searchQuery.value.trim()) return;

    searchLoading.value = true;
    searchResults.value = [];

    try {
        const query = searchQuery.value.trim();
        const searchEdition = searchLanguage.value === 'arabic' ? selectedTextStyle.value : selectedTranslation.value;
        let searchScope = 'all';

        // Add to search history
        addToSearchHistory(query);

        // Generate concept suggestions
        generateConceptSuggestions(query);

        // Determine search scope
        if (searchIn.value === 'current') {
            if (currentSurah.value) {
                searchScope = currentSurah.value.number;
            } else if (currentJuz.value) {
                // For Juz, we'll search across all surahs but filter later
                searchScope = 'all';
            } else if (selectedPage.value) {
                // For Page, we'll search across all surahs but filter later
                searchScope = 'all';
            }
        }

        // API call to search
        const response = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(query)}/${searchScope}/${searchEdition}`);
        const data = await response.json();

        if (data.data && data.data.matches) {
            let matches = data.data.matches;

            // Filter results for Juz or Page if needed
            if (searchIn.value === 'current') {
                if (currentJuz.value) {
                    // Filter by current Juz ayahs
                    const currentAyahNumbers = ayahs.value.map((ayah) => `${ayah.surah.number}:${ayah.numberInSurah}`);
                    matches = matches.filter((match) => currentAyahNumbers.includes(`${match.surah.number}:${match.numberInSurah}`));
                } else if (selectedPage.value) {
                    // Filter by current Page ayahs
                    const currentAyahNumbers = ayahs.value.map((ayah) => `${ayah.surah.number}:${ayah.numberInSurah}`);
                    matches = matches.filter((match) => currentAyahNumbers.includes(`${match.surah.number}:${match.numberInSurah}`));
                }
            }

            searchResults.value = matches;

            // If searching in Bengali, we need to also load Arabic text for each result
            if (searchLanguage.value === 'bengali') {
                await loadArabicTextForSearchResults(matches);
            }

            // If searching in Arabic, we need to also load Bengali translations
            if (searchLanguage.value === 'arabic') {
                await loadTranslationsForSearchResults(matches);
            }
        }
    } catch (error) {
        console.error('Search error:', error);
        searchResults.value = [];
    } finally {
        searchLoading.value = false;
    }
};

const loadArabicTextForSearchResults = async (matches) => {
    try {
        // Group by surah for efficient API calls
        const surahGroups = {};
        matches.forEach((match) => {
            if (!surahGroups[match.surah.number]) {
                surahGroups[match.surah.number] = [];
            }
            surahGroups[match.surah.number].push(match);
        });

        // Load Arabic text for each surah
        for (const surahNumber of Object.keys(surahGroups)) {
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${selectedTextStyle.value}`);
                const data = await response.json();

                if (data.data && data.data.ayahs) {
                    // Update the matches with Arabic text
                    surahGroups[surahNumber].forEach((match) => {
                        const arabicAyah = data.data.ayahs.find((ayah) => ayah.numberInSurah === match.numberInSurah);
                        if (arabicAyah) {
                            match.arabicText = arabicAyah.text;
                        }
                    });
                }
            } catch (error) {
                console.error(`Error loading Arabic text for surah ${surahNumber}:`, error);
            }
        }
    } catch (error) {
        console.error('Error loading Arabic text for search results:', error);
    }
};

const loadTranslationsForSearchResults = async (matches) => {
    try {
        // Group by surah for efficient API calls
        const surahGroups = {};
        matches.forEach((match) => {
            if (!surahGroups[match.surah.number]) {
                surahGroups[match.surah.number] = [];
            }
            surahGroups[match.surah.number].push(match);
        });

        // Load translations for each surah
        for (const surahNumber of Object.keys(surahGroups)) {
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${selectedTranslation.value}`);
                const data = await response.json();

                if (data.data && data.data.ayahs) {
                    // Update the matches with translation
                    surahGroups[surahNumber].forEach((match) => {
                        const translatedAyah = data.data.ayahs.find((ayah) => ayah.numberInSurah === match.numberInSurah);
                        if (translatedAyah) {
                            match.translationText = translatedAyah.text;
                        }
                    });
                }
            } catch (error) {
                console.error(`Error loading translation for surah ${surahNumber}:`, error);
            }
        }
    } catch (error) {
        console.error('Error loading translations for search results:', error);
    }
};

const clearSearch = () => {
    searchQuery.value = '';
    searchResults.value = [];
    searchIn.value = 'all';
    searchLanguage.value = 'arabic';
    conceptSuggestions.value = [];
};

// Advanced Search & Discovery Functions
const addToSearchHistory = (query) => {
    if (!searchHistory.value.includes(query)) {
        searchHistory.value.unshift(query);
        if (searchHistory.value.length > 10) {
            searchHistory.value = searchHistory.value.slice(0, 10);
        }
        localStorage.setItem('iqra_search_history', JSON.stringify(searchHistory.value));
    }
};

const generateConceptSuggestions = (query) => {
    const concepts = [];
    const lowerQuery = query.toLowerCase();

    // Map search terms to related concepts
    const conceptMap = {
        ржЖрж▓рзНрж▓рж╛рж╣: ['allah_names', 'guidance', 'forgiveness'],
        ржирж╛ржорж╛ржЬ: ['salah', 'guidance'],
        рж╕рж╛рж▓рж╛ржд: ['salah', 'guidance'],
        ржжрзЛржпрж╝рж╛: ['salah', 'forgiveness'],
        рж░рж╣ржорж╛ржи: ['allah_names', 'forgiveness'],
        рж░рж╣рж┐ржо: ['allah_names', 'forgiveness'],
        ржХрзНрж╖ржорж╛: ['forgiveness', 'guidance'],
        рждржУржмрж╛: ['forgiveness', 'guidance'],
        рж╕ржмрж░: ['patience', 'guidance'],
        ржзрзИрж░рзНржп: ['patience', 'guidance'],
        ржЬрж╛ржирзНржирж╛ржд: ['paradise', 'guidance'],
        ржЬрж╛рж╣рж╛ржирзНржирж╛ржо: ['paradise', 'guidance'],
        ржЬрзНржЮрж╛ржи: ['knowledge', 'guidance'],
        рж╣рж┐ржжрж╛ржпрж╝рж╛ржд: ['guidance', 'knowledge'],
        ржкрже: ['guidance', 'knowledge'],
        рж╕рзГрж╖рзНржЯрж┐: ['creation', 'allah_names'],
        ржкрж┐рждрж╛: ['family', 'guidance'],
        ржорж╛: ['family', 'guidance'],
        ржжрж╛ржи: ['zakat', 'guidance'],
        рж╕рж╛ржжржХрж╛: ['zakat', 'guidance'],
        рж╣ржЬ: ['hajj', 'guidance'],
        ржХрж╛ржмрж╛: ['hajj', 'guidance'],
        ржиржмрзА: ['prophets', 'guidance'],
        рж░рж╛рж╕рзВрж▓: ['prophets', 'guidance'],
    };

    // Find matching concepts
    for (const [term, relatedConcepts] of Object.entries(conceptMap)) {
        if (lowerQuery.includes(term) || term.includes(lowerQuery)) {
            relatedConcepts.forEach((conceptId) => {
                const concept = topicCategories.value.find((c) => c.id === conceptId);
                if (concept && !concepts.some((c) => c.id === conceptId)) {
                    concepts.push(concept);
                }
            });
        }
    }

    // If no specific matches, suggest popular concepts
    if (concepts.length === 0) {
        const popularConcepts = ['guidance', 'forgiveness', 'patience', 'allah_names', 'salah'];
        popularConcepts.forEach((conceptId) => {
            const concept = topicCategories.value.find((c) => c.id === conceptId);
            if (concept) {
                concepts.push(concept);
            }
        });
    }

    conceptSuggestions.value = concepts.slice(0, 6);
};

const searchByConcept = (concept) => {
    selectedTopic.value = concept;
    searchQuery.value = '';
    searchResults.value = [];
    conceptSuggestions.value = [];
    selectTopic(concept);
};

const loadSearchHistory = () => {
    const saved = localStorage.getItem('iqra_search_history');
    if (saved) {
        try {
            searchHistory.value = JSON.parse(saved);
        } catch (error) {
            console.error('Error loading search history:', error);
            searchHistory.value = [];
        }
    }
};

// Topic-Based Study Functions
const selectTopic = async (topic) => {
    selectedTopic.value = topic;

    // Check cache first
    const cacheKey = `topic_${topic.id}`;
    const cachedData = getCachedData(cacheKey);

    if (cachedData) {
        topicResults.value = cachedData;
        return; // Exit early with cached data
    }

    topicLoading.value = true;
    topicResults.value = [];

    // Clear other selections
    searchResults.value = [];
    searchQuery.value = '';

    // Map topic IDs to English search terms
    const topicSearchTerms = {
        salah: ['prayer', 'worship', 'prostrate', 'bow', 'pray'],
        zakat: ['charity', 'alms', 'spend', 'poor', 'needy'],
        hajj: ['pilgrimage', 'hajj', 'mecca', 'kaaba', 'sacred'],
        sawm: ['fasting', 'fast', 'ramadan'],
        prophets: ['prophet', 'messenger', 'abraham', 'moses', 'jesus', 'noah', 'muhammad'],
        tawhid: ['allah', 'god', 'one', 'believe', 'faith', 'worship'],
        akhirah: ['hereafter', 'paradise', 'hell', 'judgment', 'resurrection', 'day'],
        guidance: ['guidance', 'guide', 'path', 'straight', 'right'],
        family: ['wife', 'husband', 'marriage', 'parents', 'children'],
        knowledge: ['knowledge', 'know', 'wisdom', 'think', 'understand'],
        patience: ['patience', 'patient', 'grateful', 'trust', 'thankful'],
        creation: ['creation', 'create', 'earth', 'heaven', 'sun', 'moon', 'sky'],
    };

    const searchTerms = topicSearchTerms[topic.id] || [];

    try {
        // Search for multiple terms and combine results
        const allResults = [];
        const uniqueAyahs = new Set();

        // Parallel search for all terms
        const searchPromises = searchTerms.map(async (term) => {
            try {
                // Check cache for search results
                const searchCacheKey = `search_${term}_en`;
                let data = getCachedData(searchCacheKey);

                if (!data) {
                    // Search in English translation
                    const url = `https://api.alquran.cloud/v1/search/${encodeURIComponent(term)}/all/en`;
                    const response = await fetch(url);
                    data = await response.json();
                    setCachedData(searchCacheKey, data);
                }

                return { term, data };
            } catch (error) {
                console.error(`Error searching for term "${term}":`, error);
                return { term, data: null };
            }
        });

        // Wait for all searches to complete
        const searchResults = await Promise.all(searchPromises);

        // Process results
        searchResults.forEach(({ term, data }) => {
            if (data && data.data && data.data.matches) {
                data.data.matches.forEach((match) => {
                    const ayahKey = `${match.surah.number}:${match.numberInSurah}`;
                    if (!uniqueAyahs.has(ayahKey)) {
                        uniqueAyahs.add(ayahKey);
                        allResults.push(match);
                    }
                });
            }
        });

        // Sort results by surah and ayah number
        allResults.sort((a, b) => {
            if (a.surah.number !== b.surah.number) {
                return a.surah.number - b.surah.number;
            }
            return a.numberInSurah - b.numberInSurah;
        });

        topicResults.value = allResults;

        // Load translations for the results
        await loadTranslationsForTopicResults(allResults);

        // Cache the results
        setCachedData(cacheKey, topicResults.value);
    } catch (error) {
        console.error('Error loading topic results:', error);
        topicResults.value = [];
    } finally {
        topicLoading.value = false;
    }
};

const loadTranslationsForTopicResults = async (results) => {
    try {
        // Group by surah for efficient API calls
        const surahGroups = {};
        results.forEach((result) => {
            if (!surahGroups[result.surah.number]) {
                surahGroups[result.surah.number] = [];
            }
            surahGroups[result.surah.number].push(result);
        });

        // Load Arabic text and translations for all surahs in parallel
        const surahPromises = Object.keys(surahGroups).map(async (surahNumber) => {
            try {
                // Parallel fetch for Arabic and Bengali
                const [arabicData, bengaliData] = await Promise.all([
                    // Arabic text
                    (async () => {
                        const arabicCacheKey = `surah_${surahNumber}_${selectedTextStyle.value}`;
                        let data = getCachedData(arabicCacheKey);
                        if (!data) {
                            const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${selectedTextStyle.value}`);
                            data = await response.json();
                            setCachedData(arabicCacheKey, data);
                        }
                        return data;
                    })(),
                    // Bengali translation
                    (async () => {
                        const bengaliCacheKey = `surah_${surahNumber}_${selectedTranslation.value}`;
                        let data = getCachedData(bengaliCacheKey);
                        if (!data) {
                            const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${selectedTranslation.value}`);
                            data = await response.json();
                            setCachedData(bengaliCacheKey, data);
                        }
                        return data;
                    })(),
                ]);

                if (arabicData.data && arabicData.data.ayahs && bengaliData.data && bengaliData.data.ayahs) {
                    // Update the results with Arabic text and translation
                    surahGroups[surahNumber].forEach((result) => {
                        const arabicAyah = arabicData.data.ayahs.find((ayah) => ayah.numberInSurah === result.numberInSurah);
                        const bengaliAyah = bengaliData.data.ayahs.find((ayah) => ayah.numberInSurah === result.numberInSurah);
                        if (arabicAyah) {
                            result.text = arabicAyah.text;
                        }
                        if (bengaliAyah) {
                            result.translationText = bengaliAyah.text;
                        }
                    });
                }
            } catch (error) {
                console.error(`Error loading translation for surah ${surahNumber}:`, error);
            }
        });

        // Wait for all surah data to load
        await Promise.all(surahPromises);
    } catch (error) {
        console.error('Error loading translations for topic results:', error);
    }
};

const clearTopic = () => {
    selectedTopic.value = null;
    topicResults.value = [];
    showTopics.value = false;
};

// Memorization Helper Functions
const toggleProgressiveMode = () => {
    progressiveMode.value = !progressiveMode.value;
    currentAyahIndex.value = 0;

    if (progressiveMode.value) {
        // Save preference
        localStorage.setItem('iqra_progressive_mode', 'true');
    } else {
        localStorage.removeItem('iqra_progressive_mode');
    }
};

const toggleTranslationVisibility = () => {
    hideTranslation.value = !hideTranslation.value;

    if (hideTranslation.value) {
        localStorage.setItem('iqra_hide_translation', 'true');
    } else {
        localStorage.removeItem('iqra_hide_translation');
    }
};

const toggleRepeatMode = () => {
    repeatMode.value = !repeatMode.value;
    repeatCount.value = 0;

    if (repeatMode.value) {
        localStorage.setItem('iqra_repeat_mode', 'true');
    } else {
        localStorage.removeItem('iqra_repeat_mode');
    }
};

const nextAyah = () => {
    if (progressiveMode.value) {
        const maxIndex = (ayahs.value.length || displayAyahs.value.length) - 1;
        if (currentAyahIndex.value < maxIndex) {
            currentAyahIndex.value++;
        }
    }
};

const prevAyah = () => {
    if (progressiveMode.value && currentAyahIndex.value > 0) {
        currentAyahIndex.value--;
    }
};

const resetProgressive = () => {
    currentAyahIndex.value = 0;
    repeatCount.value = 0;
};

const loadMemorizationSettings = () => {
    // Load progressive mode
    if (localStorage.getItem('iqra_progressive_mode') === 'true') {
        progressiveMode.value = true;
    }

    // Load hide translation
    if (localStorage.getItem('iqra_hide_translation') === 'true') {
        hideTranslation.value = true;
    }

    // Load repeat mode
    if (localStorage.getItem('iqra_repeat_mode') === 'true') {
        repeatMode.value = true;
    }
};

// Surah names in Bengali
const getSurahBanglaName = (englishName) => {
    const names = {
        'Al-Fatiha': 'ржлрж╛рждрж┐рж╣рж╛',
        'Al-Baqarah': 'ржмрж╛ржХрзНржмрж╛рж░рж╛',
        "Ali 'Imran": 'ржЖрж▓рзЗ-ржЗржорж░рж╛ржи',
        'An-Nisa': 'ржирж┐рж╕рж╛',
        "Al-Ma'idah": 'ржорж╛ржпрж╝рж┐ржжрж╛',
        "Al-An'am": 'ржЖржиржЖржо',
        "Al-A'raf": 'ржЖрж░рж╛ржл',
        'Al-Anfal': 'ржЖржиржлрж╛рж▓',
        'At-Tawbah': 'рждрж╛ржУржмрж╛',
        Yunus: 'ржЗржЙржирзБрж╕',
        Hud: 'рж╣рзБржж',
        Yusuf: 'ржЗржЙрж╕рзБржл',
        "Ar-Ra'd": 'рж░рж╛ржж',
        Ibrahim: 'ржЗржмрж░рж╛рж╣рзАржо',
        'Al-Hijr': 'рж╣рж┐ржЬрж░',
        'An-Nahl': 'ржирж╛рж╣рж▓',
        'Al-Isra': 'ржЗрж╕рж░рж╛',
        'Al-Kahf': 'ржХрж╛рж╣ржл',
        Maryam: 'ржорж╛рж░рж┐ржпрж╝рж╛ржо',
        Taha: 'рждрзНржмрж╛-рж╣рж╛',
        'Al-Anbya': 'ржЖржорзНржмрж┐ржпрж╝рж╛',
        'Al-Hajj': 'рж╣ржЬрзНржЬ',
        "Al-Mu'minun": 'ржорзБржорж┐ржирзВржи',
        'An-Nur': 'ржирзВрж░',
        'Al-Furqan': 'ржлрзБрж░ржХрж╛ржи',
        "Ash-Shu'ara": 'рж╢рзБржЖрж░рж╛',
        'An-Naml': 'ржирж╛ржорж▓',
        'Al-Qasas': 'ржХрж╛рж╕рж╛рж╕',
        "Al-'Ankabut": 'ржЖржиржХрж╛ржмрзБржд',
        'Ar-Rum': 'рж░рзВржо',
        Luqman: 'рж▓рзБржХржорж╛ржи',
        'As-Sajdah': 'рж╕рж┐ржЬржжрж╛',
        'Al-Ahzab': 'ржЖрж╣ржпрж╛ржм',
        Saba: 'рж╕рж╛ржмрж╛',
        Fatir: 'ржлрж╛рждрж┐рж░',
        'Ya-Sin': 'ржЗржпрж╝рж╛-рж╕рзАржи',
        'As-Saffat': 'рж╕рж╛ржлржлрж╛ржд',
        Sad: 'рж╕рзЛржпрж╝рж╛ржж',
        'Az-Zumar': 'ржпрзБржорж╛рж░',
        Ghafir: 'ржЧрж╛ржлрж┐рж░',
        Fussilat: 'ржлрзБрж╕рж╕рж┐рж▓рж╛ржд',
        'Ash-Shuraa': 'рж╢рзВрж░рж╛',
        'Az-Zukhruf': 'ржпрзБржЦрж░рзБржл',
        'Ad-Dukhan': 'ржжрзБржЦрж╛ржи',
        'Al-Jathiyah': 'ржЬрж╛рж╕рж┐ржпрж╝рж╛',
        'Al-Ahqaf': 'ржЖрж╣ржХрж╛ржл',
        Muhammad: 'ржорзБрж╣рж╛ржорзНржорж╛ржж',
        'Al-Fath': 'ржлрж╛рждрж╣',
        'Al-Hujurat': 'рж╣рзБржЬрзБрж░рж╛ржд',
        Qaf: 'ржХрзНржмрж╛ржл',
        'Adh-Dhariyat': 'ржпрж╛рж░рж┐ржпрж╝рж╛ржд',
        'At-Tur': 'рждрзВрж░',
        'An-Najm': 'ржирж╛ржЬржо',
        'Al-Qamar': 'ржХрж╛ржорж╛рж░',
        'Ar-Rahman': 'рж░рж╣ржорж╛ржи',
        "Al-Waqi'ah": 'ржУржпрж╝рж╛ржХрж┐ржпрж╝рж╛',
        'Al-Hadid': 'рж╣рж╛ржжрзАржж',
        'Al-Mujadila': 'ржорзБржЬрж╛ржжрж╛рж▓рж╛',
        'Al-Hashr': 'рж╣рж╛рж╢рж░',
        'Al-Mumtahanah': 'ржорзБржорждрж╛рж╣рж┐ржирж╛',
        'As-Saff': 'рж╕рж╛ржл',
        "Al-Jumu'ah": 'ржЬрзБржоржЖ',
        'Al-Munafiqun': 'ржорзБржирж╛ржлрж┐ржХрзВржи',
        'At-Taghabun': 'рждрж╛ржЧрж╛ржмрзБржи',
        'At-Talaq': 'рждрж╛рж▓рж╛ржХ',
        'At-Tahrim': 'рждрж╛рж╣рж░рзАржо',
        'Al-Mulk': 'ржорзБрж▓ржХ',
        'Al-Qalam': 'ржХрж╛рж▓рж╛ржо',
        'Al-Haqqah': 'рж╣рж╛ржХрзНржХрж╛',
        "Al-Ma'arij": 'ржорж╛ржЖрж░рж┐ржЬ',
        Nuh: 'ржирзВрж╣',
        'Al-Jinn': 'ржЬрж┐ржи',
        'Al-Muzzammil': 'ржорзБржпржпрж╛ржорзНржорж┐рж▓',
        'Al-Muddaththir': 'ржорзБржжрзНржжрж╛рж╕рзНрж╕рж┐рж░',
        'Al-Qiyamah': 'ржХрж┐ржпрж╝рж╛ржорж╛',
        'Al-Insan': 'ржЗржирж╕рж╛ржи',
        'Al-Mursalat': 'ржорзБрж░рж╕рж╛рж▓рж╛ржд',
        'An-Naba': 'ржирж╛ржмрж╛',
        "An-Nazi'at": 'ржирж╛ржпрж┐ржЖржд',
        "'Abasa": 'ржЖржмрж╛рж╕рж╛',
        'At-Takwir': 'рждрж╛ржХржмрзАрж░',
        'Al-Infitar': 'ржЗржиржлрж┐рждрж╛рж░',
        'Al-Mutaffifin': 'ржорзБрждрж╛ржлржлрж┐ржлрзАржи',
        'Al-Inshiqaq': 'ржЗржирж╢рж┐ржХрж╛ржХ',
        'Al-Buruj': 'ржмрзБрж░рзВржЬ',
        'At-Tariq': 'рждрж╛рж░рж┐ржХ',
        "Al-A'la": 'ржЖрж▓рж╛',
        'Al-Ghashiyah': 'ржЧрж╛рж╢рж┐ржпрж╝рж╛',
        'Al-Fajr': 'ржлржЬрж░',
        'Al-Balad': 'ржмрж╛рж▓рж╛ржж',
        'Ash-Shams': 'рж╢рж╛ржорж╕',
        'Al-Layl': 'рж▓рж╛ржЗрж▓',
        'Ad-Duhaa': 'ржжрзБрж╣рж╛',
        'Ash-Sharh': 'рж╢рж╛рж░рж╣',
        'At-Tin': 'рждрзАржи',
        "Al-'Alaq": 'ржЖрж▓рж╛ржХ',
        'Al-Qadr': 'ржХржжрж░',
        'Al-Bayyinah': 'ржмрж╛ржЗржпрж╝рзНржпрж┐ржирж╛',
        'Az-Zalzalah': 'ржпрж┐рж▓ржпрж╛рж▓',
        "Al-'Adiyat": 'ржЖржжрж┐ржпрж╝рж╛ржд',
        "Al-Qari'ah": 'ржХрж╛рж░рж┐ржпрж╝рж╛',
        'At-Takathur': 'рждрж╛ржХрж╛рж╕рзБрж░',
        "Al-'Asr": 'ржЖрж╕рж░',
        'Al-Humazah': 'рж╣рзБржорж╛ржпрж╛',
        'Al-Fil': 'ржлрзАрж▓',
        Quraysh: 'ржХрзБрж░рж╛ржЗрж╢',
        "Al-Ma'un": 'ржорж╛ржЙржи',
        'Al-Kawthar': 'ржХрж╛ржУрж╕рж╛рж░',
        'Al-Kafirun': 'ржХрж╛ржлрж┐рж░рзВржи',
        'An-Nasr': 'ржирж╛рж╕рж░',
        'Al-Masad': 'ржорж╛рж╕рж╛ржж',
        'Al-Ikhlas': 'ржЗржЦрж▓рж╛рж╕',
        'Al-Falaq': 'ржлрж╛рж▓рж╛ржХ',
        'An-Nas': 'ржирж╛рж╕',
    };
    return names[englishName] || englishName;
};

// Load surahs list
const loadSurahs = async () => {
    const response = await fetch('https://api.alquran.cloud/v1/surah');
    const data = await response.json();

    surahs.value = data.data.map((surah) => ({
        ...surah,
        banglaName: getSurahBanglaName(surah.englishName),
    }));
};

// Select and load surah
const selectSurah = async () => {
    const surah = surahs.value.find((s) => s.number === currentSurahNumber.value);
    if (!surah) return;

    currentSurah.value = surah;
    currentJuz.value = null; // Clear juz when selecting surah
    selectedJuz.value = null; // Clear juz dropdown
    selectedPage.value = null; // Clear page when selecting surah

    // Stop any playing audio
    if (audioElement.value) {
        audioElement.value.pause();
        audioElement.value.src = '';
    }

    // Load Arabic text with selected style
    await loadSurahArabicText();

    // Load translation with selected translation
    await loadSurahTranslation();
};

// Select and load juz/para
const selectJuz = async () => {
    if (!selectedJuz.value) {
        // "рж╕рзВрж░рж╛ ржжрж┐ржпрж╝рзЗ ржкржбрж╝рзБржи" selected, go back to surah mode
        currentJuz.value = null;
        await selectSurah();
        return;
    }

    const juz = availableJuzs.value.find((j) => j.number === selectedJuz.value);
    if (!juz) return;

    currentJuz.value = juz;
    currentSurah.value = null; // Clear surah when selecting juz
    selectedPage.value = null; // Clear page when selecting juz

    // Stop any playing audio
    if (audioElement.value) {
        audioElement.value.pause();
        audioElement.value.src = '';
    }

    // Load juz Arabic text with selected style
    await loadJuzArabicText();

    // Load juz translation with selected translation
    await loadJuzTranslation();
};

// Select and load page
const selectPage = async () => {
    if (!selectedPage.value) return;

    currentSurah.value = null; // Clear surah when selecting page
    currentJuz.value = null; // Clear juz when selecting page

    // Stop any playing audio
    if (audioElement.value) {
        audioElement.value.pause();
        audioElement.value.src = '';
    }

    // Load page Arabic text with selected style
    await loadPageArabicText();

    // Load page translation with selected translation
    await loadPageTranslation();
};

// Load Arabic text for current surah
const loadSurahArabicText = async () => {
    if (!currentSurah.value) return;

    try {
        const arabicResponse = await fetch(`https://api.alquran.cloud/v1/surah/${currentSurah.value.number}/${selectedTextStyle.value}`);
        const arabicData = await arabicResponse.json();
        ayahs.value = arabicData.data.ayahs;
    } catch (error) {
        console.error('Error loading Arabic text:', error);
        // Fallback to default text style
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/surah/${currentSurah.value.number}`);
            const fallbackData = await fallbackResponse.json();
            ayahs.value = fallbackData.data.ayahs;
        } catch (fallbackError) {
            console.error('Error loading fallback Arabic text:', fallbackError);
        }
    }
};

// Load translation for current surah
const loadSurahTranslation = async () => {
    if (!currentSurah.value) return;

    try {
        const translationResponse = await fetch(`https://api.alquran.cloud/v1/surah/${currentSurah.value.number}/${selectedTranslation.value}`);
        const translationData = await translationResponse.json();

        const translations = {};
        translationData.data.ayahs.forEach((ayah) => {
            translations[ayah.numberInSurah] = ayah.text;
        });
        ayahTranslations.value = translations;
    } catch (error) {
        console.error('Error loading translation:', error);
        // Fallback to default translation
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/surah/${currentSurah.value.number}/bn.bengali`);
            const fallbackData = await fallbackResponse.json();

            const translations = {};
            fallbackData.data.ayahs.forEach((ayah) => {
                translations[ayah.numberInSurah] = ayah.text;
            });
            ayahTranslations.value = translations;
        } catch (fallbackError) {
            console.error('Error loading fallback translation:', fallbackError);
        }
    }
};

// Load Arabic text for current juz
const loadJuzArabicText = async () => {
    if (!currentJuz.value) return;

    try {
        const arabicResponse = await fetch(`https://api.alquran.cloud/v1/juz/${currentJuz.value.number}/${selectedTextStyle.value}`);
        const arabicData = await arabicResponse.json();
        ayahs.value = arabicData.data.ayahs;
    } catch (error) {
        console.error('Error loading Juz Arabic text:', error);
        // Fallback to default text style
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/juz/${currentJuz.value.number}`);
            const fallbackData = await fallbackResponse.json();
            ayahs.value = fallbackData.data.ayahs;
        } catch (fallbackError) {
            console.error('Error loading fallback Juz Arabic text:', fallbackError);
        }
    }
};

// Load translation for current juz
const loadJuzTranslation = async () => {
    if (!currentJuz.value) return;

    try {
        const translationResponse = await fetch(`https://api.alquran.cloud/v1/juz/${currentJuz.value.number}/${selectedTranslation.value}`);
        const translationData = await translationResponse.json();

        const translations = {};
        translationData.data.ayahs.forEach((ayah) => {
            // For juz, we need to use the absolute ayah number as key
            translations[ayah.numberInSurah] = ayah.text;
        });
        ayahTranslations.value = translations;
    } catch (error) {
        console.error('Error loading Juz translation:', error);
        // Fallback to default translation
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/juz/${currentJuz.value.number}/bn.bengali`);
            const fallbackData = await fallbackResponse.json();

            const translations = {};
            fallbackData.data.ayahs.forEach((ayah) => {
                translations[ayah.numberInSurah] = ayah.text;
            });
            ayahTranslations.value = translations;
        } catch (fallbackError) {
            console.error('Error loading fallback Juz translation:', fallbackError);
        }
    }
};

// Load Arabic text for current page
const loadPageArabicText = async () => {
    if (!selectedPage.value) return;

    try {
        const arabicResponse = await fetch(`https://api.alquran.cloud/v1/page/${selectedPage.value}/${selectedTextStyle.value}`);
        const arabicData = await arabicResponse.json();
        ayahs.value = arabicData.data.ayahs;
    } catch (error) {
        console.error('Error loading Page Arabic text:', error);
        // Fallback to default text style
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/page/${selectedPage.value}`);
            const fallbackData = await fallbackResponse.json();
            ayahs.value = fallbackData.data.ayahs;
        } catch (fallbackError) {
            console.error('Error loading fallback Page Arabic text:', fallbackError);
        }
    }
};

// Load translation for current page
const loadPageTranslation = async () => {
    if (!selectedPage.value) return;

    try {
        const translationResponse = await fetch(`https://api.alquran.cloud/v1/page/${selectedPage.value}/${selectedTranslation.value}`);
        const translationData = await translationResponse.json();

        const translations = {};
        translationData.data.ayahs.forEach((ayah) => {
            translations[ayah.numberInSurah] = ayah.text;
        });
        ayahTranslations.value = translations;
    } catch (error) {
        console.error('Error loading Page translation:', error);
        // Fallback to default translation
        try {
            const fallbackResponse = await fetch(`https://api.alquran.cloud/v1/page/${selectedPage.value}/bn.bengali`);
            const fallbackData = await fallbackResponse.json();

            const translations = {};
            fallbackData.data.ayahs.forEach((ayah) => {
                translations[ayah.numberInSurah] = ayah.text;
            });
            ayahTranslations.value = translations;
        } catch (fallbackError) {
            console.error('Error loading fallback Page translation:', fallbackError);
        }
    }
};

// Track if audio has been initialized
const audioInitialized = ref(false);

// Toggle audio playback
const toggleAudio = async () => {
    // Check if we have either surah or juz selected
    if (!currentSurah.value && !currentJuz.value) return;

    if (isPlaying.value) {
        audioElement.value.pause();
        repeatCount.value = 0; // Reset repeat count when stopping
        currentlyPlayingAyahIndex.value = -1; // Reset playing index
        return;
    }

    // Check if audio is paused and can be resumed
    if (audioElement.value.src && audioElement.value.paused && !audioElement.value.ended) {
        try {
            await audioElement.value.play();
            return;
        } catch (error) {
            // If resume fails, load fresh audio
        }
    }

    // Reset repeat count when loading new audio
    repeatCount.value = 0;

    // For Juz/Para mode, we'll play the first ayah of the juz
    // Since juz can start in the middle of a surah, we can't play full surah audio
    if (currentJuz.value) {
        if (ayahs.value.length > 0) {
            const firstAyah = ayahs.value[0];
            const surahNumber = firstAyah.surah.number;
            const ayahNumber = firstAyah.numberInSurah;

            // Create padded numbers for the audio file
            const surahPadded = surahNumber.toString().padStart(3, '0');
            const ayahPadded = ayahNumber.toString().padStart(3, '0');

            // For juz, we'll use individual ayah audio from everyayah.com
            // This ensures we start from the correct ayah even if it's in the middle of a surah
            const audioUrl = `https://everyayah.com/data/Alafasy_128kbps/${surahPadded}${ayahPadded}.mp3`;

            audioElement.value.src = audioUrl;

            // Store current ayah info for continuous playback
            audioElement.value.dataset.currentAyahIndex = '0';
            audioElement.value.dataset.playMode = 'juz';
            currentlyPlayingAyahIndex.value = 0;
        } else {
            return; // No ayahs to play
        }
    } else if (currentSurah.value) {
        // For surah mode, play the complete surah
        const surahNumber = currentSurah.value.number;

        // Create padded surah number
        const surahPadded = surahNumber < 10 ? '00' + surahNumber : surahNumber < 100 ? '0' + surahNumber : surahNumber.toString();

        // Use the selected reciter's server
        const currentReciter = availableReciters.value.find((r) => r.code === selectedReciter.value);
        if (!currentReciter) {
            // Fallback to default reciter if not found
            selectedReciter.value = 'afs';
            currentReciter = availableReciters.value.find((r) => r.code === 'afs');
        }

        const baseUrl = 'https://' + currentReciter.server + '/';
        const fileName = surahPadded + '.mp3';
        const audioUrl = baseUrl + fileName;

        audioElement.value.src = audioUrl;

        // Store play mode for surah
        audioElement.value.dataset.playMode = 'surah';
    }

    // If first time, try to initialize audio context
    if (!audioInitialized.value) {
        audioInitialized.value = true;
        try {
            // Try to play immediately
            await audioElement.value.play();
        } catch (error) {
            // If fails, wait a bit and try again
            setTimeout(async () => {
                try {
                    await audioElement.value.play();
                } catch (retryError) {
                    // Silent fail on retry
                }
            }, 200);
        }
    } else {
        // Audio already initialized, should work immediately
        try {
            await audioElement.value.play();
        } catch (error) {
            // Silent fail
        }
    }
};

// Stop audio completely
const stopAudio = () => {
    if (audioElement.value) {
        audioElement.value.pause();
        audioElement.value.currentTime = 0;
        audioElement.value.src = '';
        isPlaying.value = false;
    }
};

// Update reciter selection
const updateReciter = () => {
    // Save user preference
    localStorage.setItem('iqra_selected_reciter', selectedReciter.value);

    // Stop current audio when changing reciter
    if (isPlaying.value) {
        stopAudio();
    }
};

// Update translation selection
const updateTranslation = () => {
    // Save user preference
    localStorage.setItem('iqra_selected_translation', selectedTranslation.value);

    // Reload current content with new translation
    if (currentSurah.value) {
        loadSurahTranslation();
    } else if (currentJuz.value) {
        loadJuzTranslation();
    }
};

// Update text style selection
const updateTextStyle = () => {
    // Save user preference
    localStorage.setItem('iqra_selected_text_style', selectedTextStyle.value);

    // Reload current content with new text style
    if (currentSurah.value) {
        loadSurahArabicText();
    } else if (currentJuz.value) {
        loadJuzArabicText();
    }
};

// Handle audio errors
const handleAudioError = (event) => {
    isPlaying.value = false;
};

// Track currently playing ayah for juz mode
const currentlyPlayingAyahIndex = ref(-1);

// Handle audio ended - for repeat mode and continuous playback
const handleAudioEnded = async () => {
    const playMode = audioElement.value.dataset.playMode;
    const currentIndex = parseInt(audioElement.value.dataset.currentAyahIndex || '0');

    // Handle repeat mode first
    if (repeatMode.value && repeatCount.value < 2) {
        repeatCount.value++;

        // Small delay before repeating
        setTimeout(async () => {
            if (audioElement.value) {
                audioElement.value.currentTime = 0;
                try {
                    await audioElement.value.play();
                } catch (error) {
                    console.error('Error repeating audio:', error);
                    isPlaying.value = false;
                }
            }
        }, 500); // 500ms delay between repeats
        return;
    }

    // Reset repeat count after 3 plays
    if (repeatMode.value) {
        repeatCount.value = 0;
    }

    // Handle continuous playback for juz mode
    if (playMode === 'juz' && currentJuz.value) {
        const nextIndex = currentIndex + 1;

        if (nextIndex < ayahs.value.length) {
            // Play next ayah in the juz
            const nextAyah = ayahs.value[nextIndex];
            const surahNumber = nextAyah.surah.number;
            const ayahNumber = nextAyah.numberInSurah;

            const surahPadded = surahNumber.toString().padStart(3, '0');
            const ayahPadded = ayahNumber.toString().padStart(3, '0');
            const audioUrl = `https://everyayah.com/data/Alafasy_128kbps/${surahPadded}${ayahPadded}.mp3`;

            // Update dataset for next iteration
            audioElement.value.dataset.currentAyahIndex = nextIndex.toString();
            currentlyPlayingAyahIndex.value = nextIndex;

            // Small delay before playing next ayah
            setTimeout(async () => {
                audioElement.value.src = audioUrl;
                try {
                    await audioElement.value.play();
                } catch (error) {
                    console.error('Error playing next ayah:', error);
                    isPlaying.value = false;
                    currentlyPlayingAyahIndex.value = -1;
                }
            }, 1000); // 1 second delay between ayahs
        } else {
            // Reached end of juz
            isPlaying.value = false;
            currentlyPlayingAyahIndex.value = -1;
        }
    } else {
        // For surah mode or end of playback
        isPlaying.value = false;
        currentlyPlayingAyahIndex.value = -1;

        // If in progressive mode, move to next ayah
        if (progressiveMode.value && currentAyahIndex.value < displayAyahs.value.length - 1) {
            setTimeout(() => {
                nextAyah();
            }, 1000);
        }
    }
};

// Copy ayah to clipboard
const copyAyah = async (ayah, event) => {
    try {
        // Get the proper translation text for this ayah (handles both search results and regular ayahs)
        const translation = ayah.translationText || ayahTranslations.value[ayah.numberInSurah];
        const surahName = currentJuz.value ? ayah.surah.englishName : currentSurah.value?.banglaName || ayah.surah.englishName;

        // Get Arabic text (handles both search results and regular ayahs)
        const arabicText = ayah.arabicText || ayah.text;

        const copyText = `${arabicText}

"${translation || 'ржЕржирзБржмрж╛ржж ржЙржкрж▓ржмрзНржз ржирзЗржЗ'}"

рж╕рзВрж░рж╛ ${surahName}, ржЖржпрж╝рж╛ржд ${ayah.numberInSurah}

ржЗржХрж░рж╛ ржЕржирж▓рж╛ржЗржи ржПржХрж╛ржбрзЗржорж┐ ржерзЗржХрзЗ`;

        await navigator.clipboard.writeText(copyText);

        // Show success feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = `
      <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
      </svg>
    `;

        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    } catch (error) {
        console.error('Failed to copy:', error);
        // Fallback: show text in alert
        alert('ржЖржпрж╝рж╛рждржЯрж┐ ржХржкрж┐ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ');
    }
};

// Cache helper functions
const getCachedData = (key) => {
    const cached = apiCache.get(key);
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
        return cached.data;
    }
    // Remove expired cache
    if (cached) {
        apiCache.delete(key);
    }
    return null;
};

const setCachedData = (key, data) => {
    apiCache.set(key, {
        data: data,
        timestamp: Date.now(),
    });
};

// Initialize
onMounted(async () => {
    // Load user's preferred reciter
    const savedReciter = localStorage.getItem('iqra_selected_reciter');
    if (savedReciter && availableReciters.value.find((r) => r.code === savedReciter)) {
        selectedReciter.value = savedReciter;
    }

    // Load user's preferred translation
    const savedTranslation = localStorage.getItem('iqra_selected_translation');
    if (savedTranslation && availableTranslations.value.find((t) => t.code === savedTranslation)) {
        selectedTranslation.value = savedTranslation;
    }

    // Load user's preferred text style
    const savedTextStyle = localStorage.getItem('iqra_selected_text_style');
    if (savedTextStyle && availableTextStyles.value.find((s) => s.code === savedTextStyle)) {
        selectedTextStyle.value = savedTextStyle;
    }

    // Generate available pages
    availablePages.value = generatePageNumbers();

    // Load search history
    loadSearchHistory();

    // Load memorization settings
    loadMemorizationSettings();

    await loadSurahs();
    await selectSurah();
});
</script>

<style scoped>
/* Premium Arabic Font Stack */
.font-arabic {
    font-family: 'Amiri Quran', 'Amiri', 'Scheherazade New', 'Noto Naskh Arabic', 'Traditional Arabic', 'Al Qalam Quran Majeed', serif;
    font-feature-settings:
        'liga' on,
        'calt' on,
        'kern' on;
    font-synthesis: none;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    letter-spacing: 0.02em;
}

/* Premium Typography */
body {
    font-family: 'Inter', 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    line-height: 1.6;
}

h1,
h2,
h3 {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    font-weight: 700;
    letter-spacing: -0.025em;
}

/* Eye-friendly Color Palette */
:root {
    --primary-green: #2d5a27;
    --primary-purple: #5f5fcd;
    --accent-gold: #d4a574;
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --text-muted: #718096;
    --background-soft: #f8fafc;
    --background-cream: #fefdfb;
}

/* Premium Dropdown Styling */
select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235f5fcd' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

select:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(95, 95, 205, 0.1);
}

select:focus {
    transform: translateY(0);
    box-shadow: 0 8px 25px rgba(95, 95, 205, 0.15);
    outline: none;
}

/* Islamic Pattern for Labels */
.islamic-pattern {
    background: linear-gradient(45deg, transparent 30%, rgba(95, 95, 205, 0.08) 30%, rgba(95, 95, 205, 0.08) 70%, transparent 70%);
    backdrop-filter: blur(20px);
}

/* Smooth Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes breathe {
    0%,
    100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.dropdown-container {
    animation: fadeInUp 0.3s ease-out;
}

/* Premium Card Hover Effects */
.group:hover .font-arabic {
    animation: breathe 3s ease-in-out infinite;
}

/* Reading Mode Enhancements */
.reading-focus {
    background: linear-gradient(135deg, #fefdfb 0%, #f8fafc 100%);
    min-height: 100vh;
}

/* Smooth Scrolling */
html {
    scroll-behavior: smooth;
}

/* Selection Colors */
::selection {
    background: rgba(95, 95, 205, 0.2);
    color: var(--primary-green);
}

::-moz-selection {
    background: rgba(95, 95, 205, 0.2);
    color: var(--primary-green);
}

/* Focus Visible for Accessibility */
*:focus-visible {
    outline: 2px solid var(--primary-purple);
    outline-offset: 2px;
}

/* Mobile-First Typography */
.font-arabic {
    font-size: 1.25rem;
    line-height: 1.6;
}

@media (min-width: 640px) {
    .font-arabic {
        font-size: 1.5rem;
        line-height: 1.7;
    }
}

@media (min-width: 768px) {
    .font-arabic {
        font-size: 1.875rem;
        line-height: 1.75;
    }
}

@media (min-width: 1024px) {
    .font-arabic {
        font-size: 2.25rem;
        line-height: 1.8;
    }
}

@media (min-width: 1280px) {
    .font-arabic {
        font-size: 2.5rem;
        line-height: 1.8;
    }
}

/* Print Styles */
@media print {
    .group {
        break-inside: avoid;
        page-break-inside: avoid;
    }

    .font-arabic {
        color: black !important;
        font-size: 16pt;
        line-height: 1.8;
    }
}

/* Dark Mode Preparation */
@media (prefers-color-scheme: dark) {
    :root {
        --text-primary: #f7fafc;
        --text-secondary: #e2e8f0;
        --text-muted: #a0aec0;
        --background-soft: #1a202c;
        --background-cream: #2d3748;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .font-arabic {
        color: #000 !important;
        font-weight: 600;
    }

    .group {
        border: 2px solid #000;
    }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
